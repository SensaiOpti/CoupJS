<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coup - Multiplayer Card Game</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
    }
    
    /* Card flip animation */
    @keyframes cardFlip {
      0% {
        transform: rotateY(0deg) scale(1);
      }
      50% {
        transform: rotateY(90deg) scale(1.1);
      }
      100% {
        transform: rotateY(180deg) scale(1);
      }
    }
    
    @keyframes cardReveal {
      0% {
        transform: rotateY(180deg) scale(1);
        opacity: 0.5;
      }
      100% {
        transform: rotateY(0deg) scale(1);
        opacity: 1;
      }
    }
    
    /* Shake animation for challenges */
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    
    /* Pulse for current turn */
    @keyframes pulse {
      0%, 100% { 
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
      }
      50% { 
        box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
      }
    }
    
    /* Coin gain animation */
    @keyframes coinGain {
      0% {
        transform: translateY(-20px) scale(0.5);
        opacity: 0;
      }
      50% {
        transform: translateY(-10px) scale(1.2);
        opacity: 1;
      }
      100% {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
    }
    
    /* Fade in animation */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Eliminate player animation */
    @keyframes eliminate {
      0% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        transform: scale(0.95);
      }
      100% {
        opacity: 0.5;
        transform: scale(1);
      }
    }
    
    .card-flip {
      animation: cardFlip 0.6s ease-in-out;
    }
    
    .card-reveal {
      animation: cardReveal 0.4s ease-out;
    }
    
    .shake {
      animation: shake 0.5s ease-in-out;
    }
    
    .pulse-ring {
      animation: pulse 2s ease-in-out infinite;
    }
    
    .coin-gain {
      animation: coinGain 0.5s ease-out;
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }
    
    .eliminate {
      animation: eliminate 0.8s ease-out forwards;
    }
    
    /* Card image styling */
    img[src^="/images/cards/"] {
      image-rendering: crisp-edges;
      image-rendering: -webkit-optimize-contrast;
    }
    
    /* Custom character colors */
    .text-ambassador { color: #739C7B; }
    .text-assassin { color: #0E0E0E; }
    .text-captain { color: #33609F; }
    .text-contessa { color: #901E21; }
    .text-duke { color: #432762; }
    .text-inquisitor { color: #EAC01E; }
    
    .bg-ambassador { background-color: #5a7d62; } /* Darkened from #739C7B for better contrast with white text */
    .bg-ambassador:hover { background-color: #4a6d52; }
    .bg-assassin { background-color: #2a2a2a; } /* Lightened from #0E0E0E for better contrast with white text */
    .bg-assassin:hover { background-color: #1a1a1a; }
    .bg-captain { background-color: #33609F; }
    .bg-captain:hover { background-color: #2a5088; }
    .bg-contessa { background-color: #901E21; }
    .bg-contessa:hover { background-color: #7a1a1c; }
    .bg-duke { background-color: #432762; }
    .bg-duke:hover { background-color: #362053; }
    .bg-inquisitor { background-color: #EAC01E; }
    .bg-inquisitor:hover { background-color: #d1a819; }
    
    /* Game log default text color */
    .text-log-default { color: #999999; }
    
    /* Game log filter buttons */
    .filter-btn {
      cursor: pointer;
      user-select: none;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    // Game state
    let socket = null;
    let gameState = 'menu';
    let roomCode = '';
    let players = [];
    let spectators = [];
    let myPlayerId = null;
    let currentPlayerId = null;
    let actionInProgress = null;
    let gameLog = [];
    let selectedTarget = null;
    let playerName = localStorage.getItem('coupGuestName') || '';
    let joinCode = '';
    let myResponse = null;
    let countdown = null;
    let countdownInterval = null;
    let selectedExchangeCards = [];
    let useInquisitor = false;
    let allowSpectators = true;
    let isSpectator = false;
    let gameStats = null; // Store end game statistics (placement, coins, kills)
    let leftRooms = new Set();
    let deckSize = 0;
    let chatMode = 'separate'; // 'separate', 'unified', 'none'
    let ranked = true; // Track if game is ranked
    let hasPassword = false; // Track if game has password
    let anonymousMode = false; // Track if game is in anonymous mode

    // Game log filters
    let showAllActions = true; // true = show all players' actions, false = show only my actions
    let showChat = true; // true = show chat, false = hide chat
    let showSpectatorChat = true; // true = show spectator chat, false = hide spectator chat

    // Authentication state
    let authToken = localStorage.getItem('coupAuthToken');
    let currentUser = null;
    let authState = 'checking'; // 'checking', 'logged-out', 'logged-in'

    // Deck preference
    let deckPreference = localStorage.getItem('coupDeckPreference') || 'default';

    // Room preview state
    let previewRoomCode = '';
    let previewMode = false;
    let previewData = null;
    
    // Spectator card reveal tracking
    let spectatorRevealedCards = {}; // Format: "playerId-cardIndex": true/false
    let revealAnimatedCards = new Set(); // Cards that have already played their reveal animation

    let shouldAutoScroll = true; // Track if we should auto-scroll
    let lastActionSignature = null; // Track which action panel is showing to prevent re-animation
    let persistentPlayerId = null; // Persistent ID for reconnection

    // Sound effects system
    let audioContext = null;
    let soundEnabled = true;

    // Get or create persistent player ID
    function getOrCreatePlayerId() {
      if (!persistentPlayerId) {
        persistentPlayerId = localStorage.getItem('coupPlayerId');
        if (!persistentPlayerId) {
          persistentPlayerId = 'player_' + Math.random().toString(36).substring(2, 15) + Date.now().toString(36);
          localStorage.setItem('coupPlayerId', persistentPlayerId);
        }
      }
      return persistentPlayerId;
    }

    function initAudioContext() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      // Resume context if it's suspended
      if (audioContext.state === 'suspended') {
        audioContext.resume();
      }
    }

    function playSound(type) {
      if (!soundEnabled) return;
      
      try {
        initAudioContext();
        
        const now = audioContext.currentTime;
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        switch(type) {
          case 'your-turn':
            oscillator.frequency.setValueAtTime(440, now);
            oscillator.frequency.setValueAtTime(554, now + 0.1);
            oscillator.frequency.setValueAtTime(659, now + 0.2);
            gainNode.gain.setValueAtTime(0.3, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
            oscillator.start(now);
            oscillator.stop(now + 0.4);
            break;
            
          case 'action':
            oscillator.frequency.setValueAtTime(330, now);
            gainNode.gain.setValueAtTime(0.2, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
            oscillator.start(now);
            oscillator.stop(now + 0.15);
            break;
            
          case 'challenge':
            oscillator.frequency.setValueAtTime(800, now);
            oscillator.frequency.exponentialRampToValueAtTime(200, now + 0.3);
            gainNode.gain.setValueAtTime(0.3, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            oscillator.start(now);
            oscillator.stop(now + 0.3);
            break;
            
          case 'block':
            oscillator.frequency.setValueAtTime(250, now);
            oscillator.frequency.setValueAtTime(350, now + 0.1);
            gainNode.gain.setValueAtTime(0.25, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
            oscillator.start(now);
            oscillator.stop(now + 0.2);
            break;
            
          case 'success':
            oscillator.frequency.setValueAtTime(523, now);
            oscillator.frequency.setValueAtTime(659, now + 0.1);
            oscillator.frequency.setValueAtTime(784, now + 0.2);
            gainNode.gain.setValueAtTime(0.2, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
            oscillator.start(now);
            oscillator.stop(now + 0.4);
            break;
            
          case 'fail':
            oscillator.frequency.setValueAtTime(400, now);
            oscillator.frequency.setValueAtTime(350, now + 0.15);
            oscillator.frequency.setValueAtTime(300, now + 0.3);
            gainNode.gain.setValueAtTime(0.2, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
            oscillator.start(now);
            oscillator.stop(now + 0.4);
            break;
            
          case 'lose-influence':
            oscillator.frequency.setValueAtTime(150, now);
            oscillator.frequency.exponentialRampToValueAtTime(100, now + 0.5);
            gainNode.gain.setValueAtTime(0.25, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
            oscillator.start(now);
            oscillator.stop(now + 0.5);
            break;
            
          case 'coins':
            oscillator.frequency.setValueAtTime(800, now);
            oscillator.frequency.setValueAtTime(1000, now + 0.05);
            gainNode.gain.setValueAtTime(0.15, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            oscillator.start(now);
            oscillator.stop(now + 0.1);
            break;
            
          case 'notification':
            oscillator.frequency.setValueAtTime(440, now);
            gainNode.gain.setValueAtTime(0.15, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            oscillator.start(now);
            oscillator.stop(now + 0.1);
            break;
            
          case 'tick':
            oscillator.frequency.setValueAtTime(600, now);
            gainNode.gain.setValueAtTime(0.2, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.08);
            oscillator.start(now);
            oscillator.stop(now + 0.08);
            break;
        }
      } catch (error) {
        console.error('Error playing sound:', error);
      }
    }

    function toggleSound() {
      // Save current input values before re-rendering
      const nameInput = document.getElementById('playerName');
      if (nameInput) {
        playerName = nameInput.value;
      }
      
      const codeInput = document.getElementById('joinCode');
      if (codeInput) {
        joinCode = codeInput.value;
      }
      
      soundEnabled = !soundEnabled;
      localStorage.setItem('coupSoundEnabled', soundEnabled);
      
      // Play a test sound when enabling
      if (soundEnabled) {
        playSound('notification');
      }
      
      // Update all sound buttons without re-rendering
      const soundButtons = document.querySelectorAll('.sound-toggle-btn');
      soundButtons.forEach(btn => {
        btn.textContent = soundEnabled ? 'üîä' : 'üîá';
      });
      
      const soundButtonsWithText = document.querySelectorAll('.sound-toggle-btn-text');
      soundButtonsWithText.forEach(btn => {
        btn.textContent = soundEnabled ? 'üîä Sound On' : 'üîá Sound Off';
      });
    }

    // Load sound preference
    if (localStorage.getItem('coupSoundEnabled') !== null) {
      soundEnabled = localStorage.getItem('coupSoundEnabled') === 'true';
    }

    function scrollGameLogToBottom() {
      const logContainer = document.getElementById('gameLogContainer');
      if (logContainer && shouldAutoScroll) {
        // Small delay to ensure DOM is fully rendered
        setTimeout(() => {
          if (logContainer) {
            logContainer.scrollTop = logContainer.scrollHeight;
          }
        }, 0);
      }
    }

    function checkScrollPosition() {
      const logContainer = document.getElementById('gameLogContainer');
      if (logContainer) {
        // Check if user is near bottom (within 50px)
        const isNearBottom = logContainer.scrollHeight - logContainer.scrollTop - logContainer.clientHeight < 50;
        shouldAutoScroll = isNearBottom;
      }
    }

    const ACTIONS = {
      income: { name: 'Income', coins: 1, blockable: false, challengeable: false },
      foreignAid: { name: 'Foreign Aid', coins: 2, blockable: true, blocker: ['Duke'], challengeable: false },
      tax: { name: 'Tax', coins: 3, blockable: false, challengeable: true, card: 'Duke' },
      assassinate: { name: 'Assassinate', cost: 3, blockable: true, blocker: ['Contessa'], challengeable: true, card: 'Assassin' },
      steal: { name: 'Steal', coins: 2, blockable: true, blocker: ['Captain', 'Ambassador', 'Inquisitor'], challengeable: true, card: 'Captain' },
      exchange: { name: 'Exchange', blockable: false, challengeable: true, card: 'Ambassador' },
      examine: { name: 'Examine', blockable: false, challengeable: true, card: 'Inquisitor' },
      coup: { name: 'Coup', cost: 7, blockable: false, challengeable: false }
    };

    function initSocket() {
      socket = io({
        auth: {
          token: authToken
        }
      });
      
      socket.on('connect', () => {
        console.log('Connected to server');
        
        // Register with lobby tracking to appear in online users list
        const guestUsername = localStorage.getItem('coupGuestName') || localStorage.getItem('coupGuestUsername');
        // Server will use authenticatedUser.username if token is valid, otherwise uses this
        socket.emit('joinLobby', { username: guestUsername });
        
        // Check if we were in a room before disconnecting
        const storedRoomCode = localStorage.getItem('coupCurrentRoom');
        const storedIsSpectator = localStorage.getItem('coupIsSpectator') === 'true';
        
        if (storedRoomCode && !storedIsSpectator) {
          // Attempt to reconnect to previous game
          socket.emit('attemptReconnect', {
            roomCode: storedRoomCode,
            persistentPlayerId: getOrCreatePlayerId()
          }, (response) => {
            if (response.success) {
              console.log('Successfully reconnected to game!');
              roomCode = storedRoomCode;
              isSpectator = false;
              gameState = response.gameState;
            } else {
              console.log('Could not reconnect:', response.error);
              // Clear stored room if reconnection failed
              localStorage.removeItem('coupCurrentRoom');
            }
          });
        }
        
        render();
      });

      socket.on('disconnect', () => {
        console.log('Disconnected from server');
        render();
      });

      socket.on('gameState', (state) => {
        // Store old values before updating
        const oldGameLog = gameLog;
        const wasMyTurn = currentPlayerId === myPlayerId;
        const oldGameState = gameState;
        
        console.log('=== GAME STATE UPDATE ===');
        console.log('Old log length:', oldGameLog.length, 'New log length:', state.gameLog ? state.gameLog.length : 0);
        console.log('Old game state:', oldGameState, 'New game state:', state.state);
        console.log('Sound enabled:', soundEnabled);
        
        // Only ignore if we're in menu AND we have no room code
        if (gameState === 'menu' && !roomCode && !state.roomCode) {
          console.log('Ignoring state update - in menu');
          return;
        }
        
        if (state.useInquisitor !== undefined) {
          useInquisitor = state.useInquisitor;
        }

        if (state.allowSpectators !== undefined) {
          allowSpectators = state.allowSpectators;
        }

        if (state.chatMode !== undefined) {
          chatMode = state.chatMode;
        }

        if (state.ranked !== undefined) {
          ranked = state.ranked;
        }

        if (state.hasPassword !== undefined) {
          hasPassword = state.hasPassword;
        }

        if (state.anonymousMode !== undefined) {
          anonymousMode = state.anonymousMode;
        }

        if (state.isSpectator !== undefined) {
          isSpectator = state.isSpectator;
        }
        
        if (!roomCode && state.roomCode) {
          roomCode = state.roomCode;
        }
        
        const actionChanged = !state.actionInProgress || 
            !actionInProgress || 
            state.actionInProgress.action !== actionInProgress.action ||
            state.actionInProgress.playerId !== actionInProgress.playerId ||
            state.actionInProgress.phase !== actionInProgress.phase;
        
        if (actionChanged) {
          myResponse = null;
          
          if (state.actionInProgress && 
              (state.actionInProgress.phase === 'waiting' || state.actionInProgress.phase === 'block')) {
            startCountdown(12);
          } else {
            stopCountdown();
          }
        }
        
        // Update state first
        players = state.players;
        spectators = state.spectators || [];
        myPlayerId = state.myPlayerId;
        currentPlayerId = state.currentPlayerId;
        actionInProgress = state.actionInProgress;
        gameLog = state.gameLog;
        deckSize = state.deckSize || 0;
        
        if (state.state === 'lobby') {
          gameState = 'lobby';
        } else if (state.state === 'playing') {
          const wasPlaying = gameState === 'playing';
          gameState = 'playing';
          if (!wasPlaying) {
            shouldAutoScroll = true;
            revealAnimatedCards.clear(); // Fresh game ‚Äî allow animations to fire again
            gameStats = null; // Clear previous game stats
          }
        } else if (state.state === 'ended') {
          gameState = 'ended';
        }
        
        // NOW trigger sound effects
        console.log('Checking sound triggers - log diff:', gameLog.length - oldGameLog.length);
        if (gameLog.length > oldGameLog.length) {
          const newLogs = gameLog.slice(oldGameLog.length);
          console.log('New logs detected:', newLogs);
          newLogs.forEach(log => {
            console.log('Processing log - type:', log.type, 'message:', log.message);
            if (log.type === 'action') {
              console.log('Playing action sound');
              playSound('action');
            }
            else if (log.type === 'challenge') {
              console.log('Playing challenge sound');
              playSound('challenge');
            }
            else if (log.type === 'block') {
              console.log('Playing block sound');
              playSound('block');
            }
            else if (log.type === 'success') {
              console.log('Playing success/coins sound');
              if (log.character === 'Income' || log.character === 'ForeignAid' || log.character === 'Duke') {
                playSound('coins');
              } else {
                playSound('success');
              }
            }
            else if (log.type === 'fail') {
              console.log('Playing fail sound');
              playSound('fail');
            }
            else if (log.message.includes('loses') || log.message.includes('eliminated')) {
              console.log('Playing lose-influence sound');
              playSound('lose-influence');
            }
          });
        }
        
        // Check if it's now your turn
        const isNowMyTurn = currentPlayerId === myPlayerId;
        console.log('Turn check - was my turn:', wasMyTurn, 'is now my turn:', isNowMyTurn, 'is spectator:', isSpectator);
        if (!wasMyTurn && isNowMyTurn && !isSpectator) {
          console.log('Playing your-turn sound');
          playSound('your-turn');
        }
        
        // Preserve chat input focus across render
        const chatInput = document.getElementById('chatInput');
        const shouldRefocusChat = chatInput && document.activeElement === chatInput;
        
        render();
        
        // Restore focus to chat input if it was focused before render
        if (shouldRefocusChat) {
          setTimeout(() => {
            const newChatInput = document.getElementById('chatInput');
            if (newChatInput) {
              newChatInput.focus();
            }
          }, 0);
        }
      });

      socket.on('gameEnded', (data) => {
        console.log('=== GAME HTML VERSION: 2.0 WITH LEADERBOARD ===');
        console.log('gameEnded event received:', data);
        console.log('data.gameStats value:', data.gameStats);
        if (data && data.roomCode && leftRooms.has(data.roomCode)) {
          return;
        }
        if (gameState === 'menu' && !roomCode) {
          return;
        }
        gameState = 'ended';
        gameStats = data.gameStats || null; // Store the game statistics
        console.log('Stored gameStats:', gameStats);
        render();
      });
    }

    function createRoom() {
      let name;
      
      if (currentUser) {
        // Use authenticated username
        name = currentUser.username;
      } else {
        // Guest mode - try DOM input first, then localStorage fallback
        const nameInput = document.getElementById('playerName');
        if (nameInput && nameInput.value.trim()) {
          name = nameInput.value.trim();
        } else {
          // Coming from create-game.html redirect - use stored name or generate one
          name = localStorage.getItem('coupGuestName') || playerName || `Guest${Math.floor(Math.random() * 9999)}`;
        }
        playerName = name;
      }
      
      // Read game settings from localStorage (set by create-game.html)
      const settingsJSON = localStorage.getItem('coupGameSettings');
      let settings = {
        useInquisitor: false,
        allowSpectators: true,
        chatMode: 'separate',
        password: null,
        ranked: true,
        anonymousMode: false
      };
      
      if (settingsJSON) {
        try {
          settings = JSON.parse(settingsJSON);
          // Clear settings after reading
          localStorage.removeItem('coupGameSettings');
        } catch (e) {
          console.error('Error parsing game settings:', e);
        }
      }
      
      useInquisitor = settings.useInquisitor;
      allowSpectators = settings.allowSpectators;
      chatMode = settings.chatMode;
      
      socket.emit('createRoom', { 
        playerName: name,
        gameName: settings.gameName || null,
        useInquisitor: settings.useInquisitor, 
        allowSpectators: settings.allowSpectators,
        chatMode: settings.chatMode,
        password: settings.password,
        ranked: settings.ranked,
        anonymousMode: settings.anonymousMode || false,
        persistentPlayerId: getOrCreatePlayerId()
      }, (response) => {
        if (response.success) {
          roomCode = response.roomCode;
          isSpectator = false;
          localStorage.setItem('coupCurrentRoom', roomCode);
          localStorage.setItem('coupIsSpectator', 'false');
        } else {
          alert(response.error);
        }
      });
    }

    function previewRoom() {
      const code = document.getElementById('joinCode').value.trim().toUpperCase();
      
      if (!code) {
        alert('Please enter a room code');
        return;
      }
      
      let name;
      if (currentUser) {
        name = currentUser.username;
      } else {
        const nameInput = document.getElementById('playerName');
        if (!nameInput) {
          alert('Please enter your name');
          return;
        }
        name = nameInput.value.trim();
        if (!name) {
          alert('Please enter your name');
          return;
        }
        playerName = name;
      }
      
      previewRoomCode = code;
      
      socket.emit('previewRoom', { roomCode: code }, (response) => {
        if (response.success) {
          previewMode = true;
          previewData = response.roomData;
          players = previewData.players;
          spectators = previewData.spectators;
          useInquisitor = previewData.useInquisitor;
          allowSpectators = previewData.allowSpectators;
          chatMode = previewData.chatMode || 'separate';
          anonymousMode = previewData.anonymousMode || false;
          gameState = 'lobby';
          render();
        } else {
          alert(response.error);
        }
      });
    }

    function joinAsPlayer() {
      const password = localStorage.getItem('coupRoomPassword');
      const name = currentUser ? currentUser.username : playerName;
      
      socket.emit('joinRoom', { 
        roomCode: previewRoomCode, 
        playerName: name, 
        asSpectator: false,
        password: password,
        persistentPlayerId: getOrCreatePlayerId()
      }, (response) => {
        if (response.success) {
          roomCode = previewRoomCode;
          isSpectator = response.joinedAs === 'spectator';
          previewMode = false;
          previewRoomCode = '';
          previewData = null;
          
          // Clear password from storage
          localStorage.removeItem('coupRoomPassword');
          
          if (!isSpectator) {
            localStorage.setItem('coupCurrentRoom', roomCode);
            localStorage.setItem('coupIsSpectator', 'false');
          }
        } else {
          alert(response.error);
          // Clear password on error
          localStorage.removeItem('coupRoomPassword');
        }
      });
    }

    function joinAsSpectator() {
      const password = localStorage.getItem('coupRoomPassword');
      const name = currentUser ? currentUser.username : playerName;
      
      socket.emit('joinRoom', { 
        roomCode: previewRoomCode, 
        playerName: name, 
        asSpectator: true,
        password: password
      }, (response) => {
        if (response.success) {
          roomCode = previewRoomCode;
          isSpectator = true;
          previewMode = false;
          previewRoomCode = '';
          previewData = null;
          
          // Clear password from storage
          localStorage.removeItem('coupRoomPassword');
        } else {
          alert(response.error);
          // Clear password on error
          localStorage.removeItem('coupRoomPassword');
        }
      });
    }

    function switchToPlayer() {
      socket.emit('switchToPlayer', { 
        roomCode,
        persistentPlayerId: getOrCreatePlayerId()
      }, (response) => {
        if (!response.success) {
          alert(response.error);
        }
      });
    }

    function switchToSpectator() {
      socket.emit('switchToSpectator', { roomCode }, (response) => {
        if (!response.success) {
          alert(response.error);
        }
      });
    }

    function startGame() {
      socket.emit('startGame', { roomCode }, (response) => {
        if (!response.success) {
          alert(response.error);
        }
      });
    }

    function performAction(action, targetId = null) {
      if (!socket) return;

      socket.emit('performAction', { roomCode, action, targetId }, (response) => {
        if (!response.success) {
          alert(response.error);
        } else {
          selectedTarget = null;
          render();
        }
      });
    }

    function respondToAction(responseType, blockCard = null) {
      const response = { type: responseType };
      if (blockCard) {
        response.blockCard = blockCard;
      }
      
      myResponse = responseType;
      render();
      
      socket.emit('respondToAction', { roomCode, response }, (result) => {
        if (!result.success) {
          alert(result.error);
          myResponse = null;
          render();
        }
      });
    }

    function challengeBlock() {
      myResponse = 'challenge-block';
      render();
      
      socket.emit('challengeBlock', { roomCode }, (response) => {
        if (!response.success) {
          alert(response.error);
          myResponse = null;
          render();
        }
      });
    }

    function revealInfluence(cardIndex) {
      socket.emit('revealInfluence', { roomCode, cardIndex }, (response) => {
        if (!response.success) {
          alert(response.error);
        }
      });
    }

    function toggleExchangeCard(cardIndex) {
      const idx = selectedExchangeCards.indexOf(cardIndex);
      if (idx > -1) {
        selectedExchangeCards.splice(idx, 1);
      } else {
        const myPlayer = players.find(p => p.id === myPlayerId);
        if (selectedExchangeCards.length < myPlayer.influences.length) {
          selectedExchangeCards.push(cardIndex);
        }
      }
      render();
    }

    function completeExchange() {
      const myPlayer = players.find(p => p.id === myPlayerId);
      if (selectedExchangeCards.length !== myPlayer.influences.length) {
        alert(`You must select exactly ${myPlayer.influences.length} cards to keep`);
        return;
      }

      socket.emit('completeExchange', { roomCode, keepIndices: selectedExchangeCards }, (response) => {
        if (!response.success) {
          alert(response.error);
        } else {
          selectedExchangeCards = [];
        }
      });
    }

    function completeExamine(forceExchange) {
      socket.emit('completeExamine', { roomCode, forceExchange }, (response) => {
        if (!response.success) {
          alert(response.error);
        }
      });
    }

    function showCardToExaminer(cardIndex) {
      socket.emit('showCardToExaminer', { roomCode, cardIndex }, (response) => {
        if (!response.success) {
          alert(response.error);
        }
      });
    }

    function toggleSpectatorCardReveal(playerId, cardIndex) {
      const key = `${playerId}-${cardIndex}`;
      spectatorRevealedCards[key] = !spectatorRevealedCards[key];
      render();
    }

    function getCharacterColor(character) {
      const colors = {
        'Duke': 'text-duke',
        'Assassin': 'text-assassin',
        'Captain': 'text-captain',
        'Ambassador': 'text-ambassador',
        'Inquisitor': 'text-inquisitor',
        'Contessa': 'text-contessa',
        'Income': 'text-green-400',
        'ForeignAid': 'text-blue-300',
        'Coup': 'text-red-500'
      };
      return colors[character] || 'text-gray-300';
    }

    function getCharacterBgColor(character) {
      const bgColors = {
        'Duke': 'bg-duke',
        'Assassin': 'bg-assassin',
        'Captain': 'bg-captain',
        'Ambassador': 'bg-ambassador',
        'Inquisitor': 'bg-inquisitor',
        'Contessa': 'bg-contessa'
      };
      return bgColors[character] || '';
    }

    function getLogStyle(log) {
      let bgColor = '';
      let textColor = 'text-white';
      
      // Use character background if character is specified
      if (log.character) {
        bgColor = getCharacterBgColor(log.character);
      } else if (log.type === 'action') {
        bgColor = 'bg-blue-900 bg-opacity-20';
      } else if (log.type === 'challenge') {
        bgColor = 'bg-red-900 bg-opacity-20';
      } else if (log.type === 'block') {
        bgColor = 'bg-yellow-900 bg-opacity-20';
      } else if (log.type === 'success') {
        bgColor = 'bg-green-900 bg-opacity-20';
      } else if (log.type === 'fail') {
        bgColor = 'bg-red-900 bg-opacity-20';
      }
      
      // For info messages without character, keep white text
      // All messages now use white text for legibility
      
      return { bgColor, textColor };
    }

    function highlightCharactersInLog(message) {
      const characters = ['Duke', 'Assassin', 'Captain', 'Ambassador', 'Inquisitor', 'Contessa'];
      const actions = ['Tax', 'Steal', 'Exchange', 'Examine', 'Income', 'Foreign Aid', 'Coup', 'assassinate', 'assassinates', 'assassination', 'steals', 'steal', 'blocks'];
      
      let result = message;
      
      // Get all player and spectator names
      const allNames = [...players.map(p => p.name), ...spectators.map(s => s.name)];
      
      // Make player names bold (but not when followed by "'s turn")
      allNames.forEach(name => {
        // Escape special regex characters in the name
        const escapedName = name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        // Match the name but not when it's followed by "'s turn"
        const regex = new RegExp(`\\b(${escapedName})\\b(?!'s turn)`, 'g');
        result = result.replace(regex, `<span class="font-bold">$1</span>`);
      });
      
      // Make characters bold (no color since background provides the color)
      characters.forEach(char => {
        const regex = new RegExp(`\\b${char}\\b`, 'gi');
        result = result.replace(regex, `<span class="font-bold">${char}</span>`);
      });
      
      // Make actions bold (no color since background provides the color)
      actions.forEach(action => {
        const regex = new RegExp(`\\b${action}\\b`, 'gi');
        result = result.replace(regex, (match) => `<span class="font-bold">${match}</span>`);
      });
      
      return result;
    }

    function playAgain() {
      if (!socket) {
        console.error('No socket connection');
        return;
      }

      // Emit playAgain event with current game settings
      socket.emit('playAgain', {
        currentRoomCode: roomCode,
        useInquisitor: useInquisitor,
        allowSpectators: allowSpectators,
        chatMode: chatMode,
        ranked: ranked,
        hasPassword: hasPassword,
        anonymousMode: anonymousMode
      }, (response) => {
        if (response.success) {
          // Mark current room as left
          if (roomCode) {
            leftRooms.add(roomCode);
          }
          
          // Clear game stats
          gameStats = null;
          
          // Store the new room code and redirect
          localStorage.setItem('coupJoinCode', response.newRoomCode);
          localStorage.removeItem('coupCurrentRoom');
          localStorage.removeItem('coupIsSpectator');
          
          // Reload the page - will show preview screen with new room
          window.location.reload();
        } else {
          console.error('Failed to create new game:', response.error);
          alert('Failed to create new game. Please try again.');
        }
      });
    }

    function leaveRoom() {
      if (socket && roomCode) {
        leftRooms.add(roomCode);
        socket.emit('leaveRoom', { roomCode });
      }
      
      // Clear stored room
      localStorage.removeItem('coupCurrentRoom');
      localStorage.removeItem('coupIsSpectator');
      gameStats = null; // Clear game stats
      
      // Redirect back to lobby
      window.location.href = '/lobby.html';
    }

    function sendChatMessage(event) {
      event.preventDefault();
      
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message || !socket || !roomCode) return;
      
      // Check if chat is disabled
      if (chatMode === 'none') {
        return;
      }
      
      socket.emit('sendChatMessage', { roomCode, message });
      input.value = '';
      
      // Refocus the input so user can continue typing
      input.focus();
    }

    // Authentication functions
    async function register(username, password) {
      try {
        const response = await fetch('/api/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        
        const data = await response.json();
        
        if (data.success) {
          authToken = data.token;
          currentUser = data.user;
          authState = 'logged-in';
          localStorage.setItem('coupAuthToken', authToken);
          
          // Reconnect socket with new token
          if (socket) {
            socket.disconnect();
          }
          initSocket();
          render();
          return { success: true };
        } else {
          return { success: false, error: data.error };
        }
      } catch (error) {
        console.error('Register error:', error);
        return { success: false, error: 'Network error' };
      }
    }

    async function login(username, password) {
      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        
        const data = await response.json();
        
        if (data.success) {
          authToken = data.token;
          currentUser = data.user;
          authState = 'logged-in';
          localStorage.setItem('coupAuthToken', authToken);
          
          // Reconnect socket with new token
          if (socket) {
            socket.disconnect();
          }
          initSocket();
          render();
          return { success: true };
        } else {
          return { success: false, error: data.error };
        }
      } catch (error) {
        console.error('Login error:', error);
        return { success: false, error: 'Network error' };
      }
    }

    // Deck image path helper
    function getCardImagePath(cardName) {
      return `/images/cards/${deckPreference}/${cardName.toLowerCase()}.png`;
    }

    async function verifyAuthToken() {
      if (!authToken) {
        // If coming from lobby to join/create a game, skip auth and proceed as guest
        const hasDestination = localStorage.getItem('coupJoinCode') || localStorage.getItem('coupGameSettings');
        if (hasDestination) {
          authState = 'logged-in'; // treat as guest, currentUser stays null
        } else {
          authState = 'logged-out';
        }
        render();
        return;
      }
      
      try {
        const response = await fetch('/api/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token: authToken })
        });
        
        const data = await response.json();
        
        if (data.success) {
          currentUser = data.user;
          authState = 'logged-in';
          
          // Load deck preference from user data
          if (currentUser.deck_preference) {
            deckPreference = currentUser.deck_preference;
            localStorage.setItem('coupDeckPreference', deckPreference);
          }
        } else {
          // Token invalid, clear it
          authToken = null;
          currentUser = null;
          authState = 'logged-out';
          localStorage.removeItem('coupAuthToken');
        }
      } catch (error) {
        console.error('Verify error:', error);
        authState = 'logged-out';
      }
      
      render();
    }

    async function logout() {
      authToken = null;
      currentUser = null;
      authState = 'logged-out';
      localStorage.removeItem('coupAuthToken');
      
      // Disconnect and reconnect as guest
      if (socket) {
        socket.disconnect();
      }
      initSocket();
      
      // Return to menu
      gameState = 'menu';
      render();
    }

    async function continueAsGuest() {
      authState = 'logged-in'; // Skip auth screens
      currentUser = null; // No authenticated user
      gameState = 'menu';
      render();
    }

    async function handleLoginSubmit(event) {
      event.preventDefault();
      
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      
      const button = document.getElementById('loginButton');
      button.disabled = true;
      button.textContent = 'Logging in...';
      
      const result = await login(username, password);
      
      if (!result.success) {
        alert(result.error || 'Login failed');
        button.disabled = false;
        button.textContent = 'Login';
      }
    }

    async function handleRegisterSubmit(event) {
      event.preventDefault();
      
      const username = document.getElementById('registerUsername').value.trim();
      const password = document.getElementById('registerPassword').value;
      const confirmPassword = document.getElementById('registerConfirmPassword').value;
      
      if (password !== confirmPassword) {
        alert('Passwords do not match');
        return;
      }
      
      const button = document.getElementById('registerButton');
      button.disabled = true;
      button.textContent = 'Creating account...';
      
      const result = await register(username, password);
      
      if (!result.success) {
        alert(result.error || 'Registration failed');
        button.disabled = false;
        button.textContent = 'Create Account';
      }
    }

    function showLoginScreen() {
      authState = 'login-screen';
      render();
    }

    function showRegisterScreen() {
      authState = 'register-screen';
      render();
    }

    function backToAuthChoice() {
      authState = 'logged-out';
      render();
    }

    function cancelPreview() {
      window.location.href = '/lobby.html';
    }

    function startCountdown(seconds) {
      stopCountdown();
      countdown = seconds;
      render();
      
      countdownInterval = setInterval(() => {
        countdown--;
        
        // Play tick sound in the last 3 seconds
        if (countdown > 0 && countdown <= 3) {
          playSound('tick');
        }
        
        if (countdown <= 0) {
          stopCountdown();
        }
        
        // Only update countdown display, don't re-render entire page
        updateCountdownDisplay();
      }, 1000);
    }
    
    function updateCountdownDisplay() {
      // Update all countdown displays without re-rendering
      const countdownTimers = document.querySelectorAll('.countdown-timer');
      countdownTimers.forEach((timer, index) => {
        const isWarning = countdown <= 3;
        const isBlueTimer = timer.classList.contains('bg-blue-800') || timer.parentElement.closest('.bg-blue-900');
        
        // Update background color based on timer type
        timer.className = `countdown-timer ${isWarning ? 'bg-red-800 animate-pulse' : (isBlueTimer ? 'bg-blue-800' : 'bg-yellow-800')} px-4 py-2 rounded-lg transition-all`;
        
        const numberSpan = timer.querySelector('.countdown-number');
        const labelSpan = timer.querySelector('.countdown-label');
        
        if (numberSpan) {
          numberSpan.textContent = countdown;
          numberSpan.className = `countdown-number text-2xl font-bold ${isWarning ? 'text-red-200' : (isBlueTimer ? 'text-blue-200' : 'text-yellow-200')}`;
        }
        
        if (labelSpan) {
          labelSpan.className = `countdown-label text-sm ${isWarning ? 'text-red-300' : (isBlueTimer ? 'text-blue-300' : 'text-yellow-300')} ml-1`;
        }
      });
    }

    function stopCountdown() {
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
      countdown = null;
    }

    function toggleActionsFilter() {
      showAllActions = !showAllActions;
      render();
    }

    function toggleChatFilter() {
      showChat = !showChat;
      render();
    }

    function toggleSpectatorChatFilter() {
      showSpectatorChat = !showSpectatorChat;
      render();
    }

    function render() {
      const app = document.getElementById('app');
      
      if (!socket || !socket.connected) {
        app.innerHTML = renderConnecting();
      } else if (authState === 'checking') {
        app.innerHTML = renderConnecting();
      } else if (authState === 'logged-out') {
        app.innerHTML = renderAuthChoice();
      } else if (authState === 'login-screen') {
        app.innerHTML = renderLogin();
      } else if (authState === 'register-screen') {
        app.innerHTML = renderRegister();
      } else if (gameState === 'menu') {
        app.innerHTML = renderMenu();
      } else if (gameState === 'lobby') {
        app.innerHTML = renderLobby();
      } else if (gameState === 'playing') {
        app.innerHTML = renderGame();
        scrollGameLogToBottom();
      } else if (gameState === 'ended') {
        app.innerHTML = renderEndGame();
      }
    }

    function renderConnecting() {
      return `
        <div class="min-h-screen bg-gradient-to-br from-red-900 via-gray-900 to-black text-white flex items-center justify-center">
          <div class="bg-gray-800 rounded-lg p-8 text-center">
            <div class="text-2xl mb-4">Connecting to server...</div>
            <div class="text-sm text-gray-400">Please wait</div>
          </div>
        </div>
      `;
    }

    function renderAuthChoice() {
      return `
        <div class="min-h-screen bg-gradient-to-br from-red-900 via-gray-900 to-black text-white p-8 flex items-center justify-center">
          <div class="max-w-md w-full">
            <h1 class="text-5xl font-bold text-center mb-8 text-red-500">COUP</h1>
            
            <div class="bg-gray-800 rounded-lg p-8 shadow-2xl">
              <h2 class="text-2xl font-bold mb-6 text-center">Welcome!</h2>
              
              <div class="space-y-4">
                <button
                  onclick="showLoginScreen()"
                  class="w-full bg-red-600 hover:bg-red-700 p-4 rounded text-xl font-bold"
                >
                  Login
                </button>
                
                <button
                  onclick="showRegisterScreen()"
                  class="w-full bg-blue-600 hover:bg-blue-700 p-4 rounded text-xl font-bold"
                >
                  Create Account
                </button>
                
                <div class="text-center text-gray-400 my-4">- OR -</div>
                
                <button
                  onclick="continueAsGuest()"
                  class="w-full bg-gray-600 hover:bg-gray-700 p-4 rounded text-lg"
                >
                  Continue as Guest
                </button>
              </div>
              
              <div class="mt-6 p-4 bg-gray-700 rounded">
                <h3 class="font-bold mb-2">Why create an account?</h3>
                <ul class="text-sm text-gray-300 space-y-1">
                  <li>üîä Track your stats and Elo rating</li>
                  <li>üèÜ Compete on leaderboards</li>
                  <li>üìà View your match history</li>
                  <li>‚≠ê¬ê Build your reputation</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderLogin() {
      return `
        <div class="min-h-screen bg-gradient-to-br from-red-900 via-gray-900 to-black text-white p-8 flex items-center justify-center">
          <div class="max-w-md w-full">
            <h1 class="text-5xl font-bold text-center mb-8 text-red-500">COUP</h1>
            
            <div class="bg-gray-800 rounded-lg p-8 shadow-2xl">
              <h2 class="text-2xl font-bold mb-6">Login</h2>
              
              <form onsubmit="handleLoginSubmit(event)" class="space-y-4">
                <div>
                  <label class="block text-sm font-bold mb-2">Username</label>
                  <input
                    type="text"
                    id="loginUsername"
                    required
                    class="w-full p-3 bg-gray-700 rounded border border-gray-600 text-white"
                    autocomplete="username"
                  />
                </div>
                
                <div>
                  <label class="block text-sm font-bold mb-2">Password</label>
                  <input
                    type="password"
                    id="loginPassword"
                    required
                    class="w-full p-3 bg-gray-700 rounded border border-gray-600 text-white"
                    autocomplete="current-password"
                  />
                </div>
                
                <button
                  type="submit"
                  id="loginButton"
                  class="w-full bg-red-600 hover:bg-red-700 p-4 rounded text-xl font-bold"
                >
                  Login
                </button>
              </form>
              
              <div class="mt-6 text-center">
                <button
                  onclick="backToAuthChoice()"
                  class="text-gray-400 hover:text-white"
                >
                  ‚Üê Back
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderRegister() {
      return `
        <div class="min-h-screen bg-gradient-to-br from-red-900 via-gray-900 to-black text-white p-8 flex items-center justify-center">
          <div class="max-w-md w-full">
            <h1 class="text-5xl font-bold text-center mb-8 text-red-500">COUP</h1>
            
            <div class="bg-gray-800 rounded-lg p-8 shadow-2xl">
              <h2 class="text-2xl font-bold mb-6">Create Account</h2>
              
              <form onsubmit="handleRegisterSubmit(event)" class="space-y-4">
                <div>
                  <label class="block text-sm font-bold mb-2">Username</label>
                  <input
                    type="text"
                    id="registerUsername"
                    required
                    minlength="3"
                    maxlength="20"
                    pattern="[a-zA-Z0-9_]+"
                    class="w-full p-3 bg-gray-700 rounded border border-gray-600 text-white"
                    autocomplete="username"
                  />
                  <div class="text-xs text-gray-400 mt-1">3-20 characters, letters/numbers/underscores only</div>
                </div>
                
                <div>
                  <label class="block text-sm font-bold mb-2">Password</label>
                  <input
                    type="password"
                    id="registerPassword"
                    required
                    minlength="6"
                    class="w-full p-3 bg-gray-700 rounded border border-gray-600 text-white"
                    autocomplete="new-password"
                  />
                  <div class="text-xs text-gray-400 mt-1">At least 6 characters</div>
                </div>
                
                <div>
                  <label class="block text-sm font-bold mb-2">Confirm Password</label>
                  <input
                    type="password"
                    id="registerConfirmPassword"
                    required
                    minlength="6"
                    class="w-full p-3 bg-gray-700 rounded border border-gray-600 text-white"
                    autocomplete="new-password"
                  />
                </div>
                
                <button
                  type="submit"
                  id="registerButton"
                  class="w-full bg-blue-600 hover:bg-blue-700 p-4 rounded text-xl font-bold"
                >
                  Create Account
                </button>
              </form>
              
              <div class="mt-6 text-center">
                <button
                  onclick="backToAuthChoice()"
                  class="text-gray-400 hover:text-white"
                >
                  ‚Üê Back
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderMenu() {
      const displayName = currentUser ? currentUser.username : (playerName || 'Guest');
      const eloRating = currentUser && currentUser.stats ? currentUser.stats.elo_rating : null;
      
      return `
        <div class="min-h-screen bg-gradient-to-br from-red-900 via-gray-900 to-black text-white p-8">
          <div class="max-w-md mx-auto">
            <div class="flex justify-between items-center mb-8">
              <h1 class="text-5xl font-bold text-red-500">COUP</h1>
              <div class="flex gap-3">
                <button onclick="toggleSound()" class="sound-toggle-btn bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded text-sm">
                  ${soundEnabled ? 'üîä' : 'üîá'}
                </button>
                ${currentUser ? `
                  <a href="/profile.html?user=${currentUser.username}" class="bg-blue-700 hover:bg-blue-600 px-4 py-2 rounded text-sm">
                    üë§ Profile
                  </a>
                ` : ''}
                <a href="/leaderboards.html" class="bg-purple-700 hover:bg-purple-600 px-4 py-2 rounded text-sm">
                  üèÜ Leaderboards
                </a>
                <a href="/rules.html" target="_blank" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded text-sm">
                  üìñ Rules
                </a>
              </div>
            </div>
            
            ${currentUser ? `
              <div class="bg-gray-800 rounded-lg p-6 mb-6 shadow-2xl">
                <div class="flex justify-between items-center">
                  <div>
                    <div class="text-sm text-gray-400">Logged in as</div>
                    <div class="text-2xl font-bold text-red-400">${currentUser.username}</div>
                    ${eloRating ? `<div class="text-sm text-yellow-500">‚≠ê Elo: ${eloRating}</div>` : ''}
                  </div>
                  <div class="flex gap-2">
                    <a
                      href="/profile.html?user=${currentUser.username}"
                      class="bg-blue-700 hover:bg-blue-600 px-4 py-2 rounded text-sm"
                    >
                      üë§ Profile
                    </a>
                    <button
                      onclick="logout()"
                      class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded text-sm"
                    >
                      Logout
                    </button>
                  </div>
                </div>
              </div>
            ` : ''}
            
            
            <div class="bg-gray-800 rounded-lg p-8 shadow-2xl">
              ${!currentUser ? `
                <input
                  type="text"
                  id="playerName"
                  placeholder="Enter your display name"
                  class="w-full p-3 mb-4 bg-gray-700 rounded border border-gray-600 text-white"
                  value="${playerName}"
                  oninput="playerName = this.value"
                  onkeypress="if(event.key==='Enter') createRoom()"
                />
              ` : ''}
              
              <div class="mb-4 bg-gray-700 rounded p-4 space-y-3">
                <h3 class="text-lg font-bold mb-3">Game Options</h3>
                <label class="flex items-center gap-3 cursor-pointer">
                  <input
                    type="checkbox"
                    id="useInquisitor"
                    class="w-5 h-5 cursor-pointer"
                  />
                  <div>
                    <div class="font-bold">Use Inquisitor (Expansion)</div>
                    <div class="text-sm text-gray-400">Replaces Ambassador with Inquisitor</div>
                  </div>
                </label>
                <label class="flex items-center gap-3 cursor-pointer">
                  <input
                    type="checkbox"
                    id="allowSpectators"
                    class="w-5 h-5 cursor-pointer"
                    checked
                  />
                  <div>
                    <div class="font-bold">Allow Spectators</div>
                    <div class="text-sm text-gray-400">Let others watch the game</div>
                  </div>
                </label>
                <div>
                  <label class="font-bold block mb-2">Chat Mode</label>
                  <select id="chatMode" class="w-full p-2 bg-gray-600 rounded border border-gray-500 text-white cursor-pointer">
                    <option value="separate">Separate Chats</option>
                    <option value="unified">Unified Chat</option>
                    <option value="none">No Chat</option>
                  </select>
                </div>
              </div>
              
              <button
                onclick="createRoom()"
                class="w-full bg-red-600 hover:bg-red-700 p-4 rounded text-xl font-bold mb-4"
              >
                Create New Room
              </button>

              <div class="text-center text-gray-400 my-4">- OR -</div>

              <input
                type="text"
                id="joinCode"
                placeholder="Enter room code"
                class="w-full p-3 mb-4 bg-gray-700 rounded border border-gray-600 text-white uppercase"
                value="${joinCode}"
                oninput="joinCode = this.value.toUpperCase()"
                onkeypress="if(event.key==='Enter') previewRoom()"
              />

              <button
                onclick="previewRoom()"
                class="w-full bg-blue-600 hover:bg-blue-700 p-4 rounded text-xl font-bold mb-4"
              >
                Join Room
              </button>
              
              <div class="text-center text-gray-400 my-4">- OR -</div>
              
              <a
                href="/lobby.html"
                class="w-full bg-green-600 hover:bg-green-700 p-4 rounded text-xl font-bold block text-center"
              >
                üéÆ Go to Game Lobby
              </a>
              <p class="text-center text-sm text-gray-400 mt-2">Browse active games ‚Ä¢ Chat with players ‚Ä¢ Join instantly</p>
            </div>
          </div>
        </div>
      `;
    }

    function renderLobby() {
      const roomIsPlaying = previewMode && previewData && previewData.state === 'playing';
      
      return `
        <div class="min-h-screen bg-gradient-to-br from-red-900 via-gray-900 to-black text-white p-8">
          <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-6">
              <h1 class="text-3xl font-bold text-red-500">COUP</h1>
              <div class="flex gap-3">
                <button onclick="toggleSound()" class="sound-toggle-btn bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded text-sm">
                  ${soundEnabled ? 'üîä' : 'üîá'}
                </button>
                <button onclick="${previewMode ? 'cancelPreview' : 'leaveRoom'}()" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">
                  ${previewMode ? 'Cancel' : 'Leave Room'}
                </button>
              </div>
            </div>

            <div class="bg-gray-800 rounded-lg p-8 shadow-2xl">
              <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-red-500 mb-4">Game Lobby</h2>
                <p class="text-sm text-gray-400 mb-3">${previewMode ? 'Preview - Choose how to join' : 'Waiting for players'}</p>
                ${roomIsPlaying ? '<p class="text-sm text-yellow-500 mb-3">‚ö†Ô∏è Game in progress</p>' : ''}
                <div class="flex gap-3 justify-center flex-wrap">
                  <span class="px-3 py-1 rounded ${useInquisitor ? 'bg-inquisitor text-white' : 'bg-ambassador text-white'}">
                    ${useInquisitor ? '‚öîÔ∏è Inquisitor' : 'üé¥ Ambassador'}
                  </span>
                  <span class="px-3 py-1 rounded ${allowSpectators ? 'bg-blue-900 text-blue-200' : 'bg-gray-700 text-gray-300'}">
                    ${allowSpectators ? 'üëÅÔ∏è Spectators Allowed' : 'üö´ No Spectators'}
                  </span>
                  <span class="px-3 py-1 rounded ${chatMode === 'none' ? 'bg-gray-700 text-gray-300' : 'bg-green-900 text-green-200'}">
                    ${chatMode === 'unified' ? 'üí¨ Unified Chat' : chatMode === 'separate' ? 'üí¨ Separate Chats' : 'üö´ No Chat'}
                  </span>
                  ${anonymousMode ? '<span class="px-3 py-1 rounded bg-orange-900 text-orange-200">üé≠ Anonymous</span>' : ''}
                </div>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                  <h3 class="text-xl mb-4 flex items-center justify-between">
                    <span>Players (${players.length}/6)</span>
                    ${!previewMode && isSpectator && !roomIsPlaying ? `
                      <button 
                        onclick="switchToPlayer()" 
                        class="text-sm bg-red-600 hover:bg-red-700 px-3 py-1 rounded ${players.length >= 6 ? 'opacity-50 cursor-not-allowed' : ''}"
                        ${players.length >= 6 ? 'disabled' : ''}
                      >
                        Join as Player
                      </button>
                    ` : ''}
                  </h3>
                  <div class="space-y-2">
                    ${players.map(player => {
                      const isAuth = player.username && !player.isGuest;
                      const eloRating = player.stats ? player.stats.elo_rating : null;
                      return `
                        <div class="bg-gray-700 p-3 rounded flex items-center justify-between">
                          <div class="flex items-center gap-2">
                            <span>${player.name}</span>
                            ${isAuth ? `<span class="text-xs bg-green-600 px-2 py-1 rounded">‚≠ê¬ê USER</span>` : `<span class="text-xs bg-gray-600 px-2 py-1 rounded">üë§ GUEST</span>`}
                            ${isAuth && eloRating ? `<span class="text-xs text-yellow-400">Elo: ${eloRating}</span>` : ''}
                          </div>
                          ${player.isMe ? '<span class="text-xs bg-red-600 px-2 py-1 rounded">YOU</span>' : ''}
                        </div>
                      `;
                    }).join('')}
                    ${players.length === 0 ? '<div class="text-gray-500 text-center py-4">No players yet</div>' : ''}
                  </div>
                </div>

                ${allowSpectators ? `
                  <div>
                    <h3 class="text-xl mb-4 flex items-center justify-between">
                      <span>Spectators (${spectators.length})</span>
                      ${!previewMode && !isSpectator && !roomIsPlaying ? `
                        <button 
                          onclick="switchToSpectator()" 
                          class="text-sm bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded"
                        >
                          Switch to Spectator
                        </button>
                      ` : ''}
                    </h3>
                    <div class="space-y-2">
                      ${spectators.map(spectator => `
                        <div class="bg-gray-700 p-3 rounded flex items-center justify-between">
                          <span>${spectator.name}</span>
                          ${spectator.isMe ? '<span class="text-xs bg-blue-600 px-2 py-1 rounded">YOU</span>' : ''}
                        </div>
                      `).join('')}
                      ${spectators.length === 0 ? '<div class="text-gray-500 text-center py-4">No spectators</div>' : ''}
                    </div>
                  </div>
                ` : ''}
              </div>

              ${previewMode ? `
                <div class="space-y-3">
                  ${roomIsPlaying ? `
                    <div class="bg-yellow-900 border border-yellow-600 rounded p-4 text-center text-yellow-200 mb-3">
                      This game is already in progress. You can join as a spectator to watch!
                    </div>
                  ` : ''}
                  <button 
                    onclick="joinAsPlayer()" 
                    class="w-full bg-red-600 hover:bg-red-700 p-4 rounded text-xl font-bold ${(players.length >= 6 || roomIsPlaying) ? 'opacity-50 cursor-not-allowed' : ''}"
                    ${(players.length >= 6 || roomIsPlaying) ? 'disabled' : ''}
                  >
                    Join as Player ${roomIsPlaying ? '(Game in Progress)' : players.length >= 6 ? '(Full)' : ''}
                  </button>
                  ${allowSpectators ? `
                    <button 
                      onclick="joinAsSpectator()" 
                      class="w-full bg-blue-600 hover:bg-blue-700 p-4 rounded text-xl font-bold"
                    >
                      Join as Spectator
                    </button>
                  ` : ''}
                </div>
              ` : `
                ${!isSpectator && players.length >= 2 && !roomIsPlaying ? `
                  <button onclick="startGame()" class="w-full bg-red-600 hover:bg-red-700 p-4 rounded text-xl font-bold">
                    Start Game
                  </button>
                ` : !isSpectator && !roomIsPlaying ? `
                  <div class="text-center text-gray-400">Waiting for at least 2 players...</div>
                ` : !roomIsPlaying ? `
                  <div class="text-center text-blue-400">Waiting for host to start the game...</div>
                ` : ''}
              `}
            </div>
          </div>
        </div>
      `;
    }

    function renderGame() {
      const myPlayer = players.find(p => p.id === myPlayerId);
      const isMyTurn = currentPlayerId === myPlayerId && !isSpectator;
      const canIRespond = actionInProgress && actionInProgress.playerId !== myPlayerId && myPlayer?.alive && !isSpectator;
      const canIChallengeBlock = actionInProgress && actionInProgress.phase === 'block' && actionInProgress.blockerId !== myPlayerId && myPlayer?.alive && !isSpectator;
      const mustReveal = myPlayer?.mustRevealInfluence && !isSpectator;
      const mustExchange = myPlayer?.mustChooseExchange && !isSpectator;
      const mustExamine = myPlayer?.mustChooseExamine && !isSpectator;
      const mustShowCard = myPlayer?.mustShowCardToExaminer && !isSpectator;
      const examineTarget = mustExamine ? players.find(p => p.id === myPlayer.examineTargetId) : null;
      
      // Check if anyone is waiting to reveal an influence
      const someoneRevealing = players.find(p => p.mustRevealInfluence);
      const someoneExchanging = players.find(p => p.mustChooseExchange);
      const someoneExamining = players.find(p => p.mustChooseExamine);
      const someoneShowingCard = players.find(p => p.mustShowCardToExaminer);
      
      // Track if action panel is new (for animations)
      const currentActionSignature = actionInProgress ? 
        `${actionInProgress.action}-${actionInProgress.playerId}-${actionInProgress.phase}` : 
        null;
      const isNewAction = currentActionSignature !== lastActionSignature;
      if (isNewAction) {
        lastActionSignature = currentActionSignature;
      }
      const actionAnimationClass = isNewAction ? 'shake fade-in' : '';

      return `
        <div class="min-h-screen bg-gradient-to-br from-red-900 via-gray-900 to-black text-white p-4">
          <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center mb-6">
              <div class="flex items-center gap-4">
                <h1 class="text-3xl font-bold text-red-500">COUP</h1>
                ${isSpectator ? '<span class="bg-blue-600 px-3 py-1 rounded text-sm">üëÅÔ∏è SPECTATING</span>' : ''}
              </div>
              <div class="flex gap-4 items-center">
                <button onclick="toggleSound()" class="sound-toggle-btn-text bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded text-sm flex items-center gap-2">
                  ${soundEnabled ? 'üîä Sound On' : 'üîá Sound Off'}
                </button>
                <div class="text-gray-400">Room: ${roomCode}</div>
                <button onclick="leaveRoom()" class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-sm">
                  Leave
                </button>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div class="lg:col-span-2">
                <div class="grid grid-cols-2 gap-4 mb-6">
                  ${players.map(player => {
                    const isAuth = player.username && !player.isGuest;
                    const eloRating = player.stats ? player.stats.elo_rating : null;
                    
                    return `
                    <div class="bg-gray-800 rounded-lg p-4 ${player.id === currentPlayerId ? 'ring-2 ring-red-500 pulse-ring' : ''} ${!player.alive ? 'eliminate' : ''} ${player.disconnected ? 'opacity-75' : ''}">
                      <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                          <div class="flex items-center gap-2 mb-1">
                            <h3 class="font-bold text-lg">
                              ${player.name}
                              ${player.isMe ? '<span class="text-xs ml-2 text-red-500">(YOU)</span>' : ''}
                              ${player.disconnected ? '<span class="text-xs ml-2 text-yellow-500">‚ö†Ô∏è¬è DISCONNECTED</span>' : ''}
                              ${player.hasLeft ? '<span class="text-xs ml-2 text-gray-400">LEFT</span>' : ''}
                            </h3>
                          </div>
                          <div class="flex items-center gap-2 flex-wrap">
                            ${isAuth ? `<span class="text-xs bg-green-600 px-2 py-1 rounded">‚≠ê¬ê</span>` : `<span class="text-xs bg-gray-600 px-2 py-1 rounded">üë§</span>`}
                            ${isAuth && eloRating ? `<span class="text-xs text-yellow-400 font-semibold">${eloRating}</span>` : ''}
                            ${player.id === currentPlayerId ? '<span class="text-xs bg-red-600 px-2 py-1 rounded">TURN</span>' : ''}
                          </div>
                        </div>
                        <div class="flex items-center gap-1 text-yellow-500">
                          <span>üí∞</span>
                          <span class="font-bold">${player.coins}</span>
                        </div>
                      </div>
                      
                      <div class="flex gap-2">
                        ${player.influences?.map((influence, idx) => {
                          const key = `${player.id}-${idx}`;
                          const spectatorRevealed = spectatorRevealedCards[key];
                          const shouldShowCard = influence.revealed || player.isMe || (isSpectator && spectatorRevealed);
                          const cardName = influence.card ? influence.card.toLowerCase() : 'back';

                          // Only animate the reveal once per card
                          let revealAnimClass = '';
                          if (influence.revealed) {
                            if (!revealAnimatedCards.has(key)) {
                              revealAnimatedCards.add(key);
                              revealAnimClass = 'card-reveal';
                            }
                          }
                          
                          return `
                            <div class="relative flex-1 ${influence.revealed ? `bg-red-900 border-2 border-red-600 ${revealAnimClass}` : 'bg-gray-700'} rounded p-2 text-center ${isSpectator && !influence.revealed ? 'cursor-pointer hover:bg-gray-600' : ''}" ${isSpectator && !influence.revealed ? `onclick="toggleSpectatorCardReveal('${player.id}', ${idx})"` : ''}>
                              ${influence.revealed ? `
                                <img src="${getCardImagePath(cardName)}" alt="${influence.card}" class="w-full h-auto rounded opacity-50" />
                                <div class="absolute inset-0 flex items-center justify-center">
                                  <div class="text-xs font-bold text-red-300 bg-red-900 bg-opacity-90 px-2 py-1 rounded">LOST</div>
                                </div>
                              ` : shouldShowCard ? `
                                <img src="${getCardImagePath(cardName)}" alt="${influence.card}" class="w-full h-auto rounded" />
                                ${isSpectator && spectatorRevealed ? '<div class="absolute top-1 right-1 text-blue-400 text-xs">üëÅÔ∏è</div>' : ''}
                              ` : `
                                <img src="${getCardImagePath('back')}" alt="Hidden card" class="w-full h-auto rounded" />
                                ${isSpectator ? '<div class="absolute bottom-1 left-0 right-0 text-xs text-gray-400 text-center">Click to peek</div>' : ''}
                              `}
                            </div>
                          `;
                        }).join('')}
                      </div>
                    </div>
                  `}).join('')}
                </div>

                ${canIRespond && actionInProgress.phase === 'waiting' ? `
                  <div class="mb-6 bg-yellow-900 border-2 border-yellow-600 rounded-lg p-6 ${actionAnimationClass}">
                    <div class="flex justify-between items-center mb-4">
                      <h3 class="text-xl font-bold text-yellow-300">Action in Progress</h3>
                      ${actionInProgress.pausedForDisconnection ? `
                        <div class="bg-yellow-800 px-4 py-2 rounded-lg">
                          <span class="text-sm text-yellow-200">‚è∏Ô∏è Paused - Waiting for reconnection</span>
                        </div>
                      ` : countdown !== null ? `
                        <div class="flex flex-col items-end gap-1">
                          <div class="countdown-timer ${countdown <= 3 ? 'bg-red-800 animate-pulse' : 'bg-yellow-800'} px-4 py-2 rounded-lg transition-all">
                            <span class="countdown-number text-2xl font-bold ${countdown <= 3 ? 'text-red-200' : 'text-yellow-200'}">${countdown}</span>
                            <span class="countdown-label text-sm ${countdown <= 3 ? 'text-red-300' : 'text-yellow-300'} ml-1">sec</span>
                          </div>
                          ${actionInProgress.totalResponders > 0 ? `
                            <div class="text-xs text-yellow-400">
                              ${actionInProgress.respondedCount}/${actionInProgress.totalResponders} responded
                            </div>
                          ` : ''}
                        </div>
                      ` : ''}
                    </div>
                    <p class="mb-4 text-yellow-100">${gameLog[gameLog.length - 1]?.message}</p>
                    
                    ${myResponse ? `
                      <div class="bg-green-900 border border-green-600 rounded p-4 text-center">
                        <div class="text-green-300 font-bold mb-2">‚úì Response Recorded</div>
                        <div class="text-green-200 text-sm">Waiting for other players...</div>
                      </div>
                    ` : `
                      <div class="space-y-3">
                        <button onclick="respondToAction('pass')" class="w-full bg-green-600 hover:bg-green-700 p-4 rounded font-bold">
                          Allow
                        </button>
                        ${actionInProgress.canBlock && (!actionInProgress.targetId || actionInProgress.targetId === myPlayerId) ? `
                          <div>
                            <p class="text-yellow-200 mb-2 font-bold">Block with:</p>
                            <div class="grid grid-cols-1 gap-2">
                              ${(actionInProgress.blocker || ACTIONS[actionInProgress.action].blocker).map(card => `
                                <button onclick="respondToAction('block', '${card}')" class="bg-blue-600 hover:bg-blue-700 p-4 rounded font-bold text-white">
                                  ${card}
                                </button>
                              `).join('')}
                            </div>
                          </div>
                        ` : ''}
                        ${actionInProgress.canChallenge ? `
                          <button onclick="respondToAction('challenge')" class="w-full bg-red-600 hover:bg-red-700 p-4 rounded font-bold">
                            Challenge
                          </button>
                        ` : ''}
                      </div>
                    `}
                  </div>
                ` : ''}

                ${canIChallengeBlock ? `
                  <div class="mb-6 bg-blue-900 border-2 border-blue-600 rounded-lg p-6 ${actionAnimationClass}">
                    <div class="flex justify-between items-center mb-4">
                      <h3 class="text-xl font-bold text-blue-300">Block Declared</h3>
                      ${actionInProgress.pausedForDisconnection ? `
                        <div class="bg-blue-800 px-4 py-2 rounded-lg">
                          <span class="text-sm text-blue-200">‚è∏Ô∏è Paused - Waiting for reconnection</span>
                        </div>
                      ` : countdown !== null ? `
                        <div class="flex flex-col items-end gap-1">
                          <div class="countdown-timer ${countdown <= 3 ? 'bg-red-800 animate-pulse' : 'bg-blue-800'} px-4 py-2 rounded-lg transition-all">
                            <span class="countdown-number text-2xl font-bold ${countdown <= 3 ? 'text-red-200' : 'text-blue-200'}">${countdown}</span>
                            <span class="countdown-label text-sm ${countdown <= 3 ? 'text-red-300' : 'text-blue-300'} ml-1">sec</span>
                          </div>
                          ${actionInProgress.totalResponders > 0 ? `
                            <div class="text-xs text-blue-400">
                              ${actionInProgress.respondedCount}/${actionInProgress.totalResponders} responded
                            </div>
                          ` : ''}
                        </div>
                      ` : ''}
                    </div>
                    <p class="mb-4 text-blue-100">
                      ${players.find(p => p.id === actionInProgress.blockerId)?.name} blocked with ${actionInProgress.blockCard}
                    </p>
                    
                    ${myResponse ? `
                      <div class="bg-green-900 border border-green-600 rounded p-4 text-center">
                        <div class="text-green-300 font-bold mb-2">‚úì Response Recorded</div>
                        <div class="text-green-200 text-sm">Waiting for other players...</div>
                      </div>
                    ` : `
                      <div class="flex gap-3">
                        <button onclick="respondToAction('pass')" class="bg-green-600 hover:bg-green-700 p-3 rounded flex-1 font-bold">
                          Accept Block
                        </button>
                        <button onclick="challengeBlock()" class="bg-red-600 hover:bg-red-700 p-3 rounded flex-1 font-bold">
                          Challenge Block
                        </button>
                      </div>
                    `}
                  </div>
                ` : ''}

                ${mustReveal ? `
                  <div class="mb-6 bg-red-900 border-2 border-red-600 rounded-lg p-6 shake">
                    <h3 class="text-xl font-bold mb-4 text-red-300">Choose a Card to Reveal</h3>
                    <p class="mb-4 text-red-100">You must reveal ${myPlayer.influencesToLose || 1} influence${(myPlayer.influencesToLose || 1) > 1 ? 's' : ''}.</p>
                    <div class="flex gap-3 justify-center">
                      ${myPlayer.influences.map((influence, idx) => `
                        ${!influence.revealed ? `
                          <button 
                            onclick="revealInfluence(${idx})" 
                            class="bg-red-600 hover:bg-red-700 p-4 rounded text-center flex-1 max-w-xs"
                          >
                            <img src="${getCardImagePath(influence.card)}" alt="${influence.card}" class="w-full h-auto rounded mb-2" />
                            <div class="text-sm font-bold">Reveal this card</div>
                          </button>
                        ` : ''}
                      `).join('')}
                    </div>
                  </div>
                ` : ''}

                ${mustExchange ? `
                  <div class="mb-6 bg-teal-900 border-2 border-teal-600 rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4 text-teal-300">Exchange Cards</h3>
                    <p class="mb-4 text-teal-100">You drew ${myPlayer.exchangeCards.length} card(s). Select ${myPlayer.influences.length} card(s) to KEEP (the rest will be returned to the deck).</p>
                    <div class="grid grid-cols-2 gap-3 mb-4">
                      ${[...myPlayer.influences, ...myPlayer.exchangeCards].map((card, idx) => {
                        const cardName = (card.card || card).toLowerCase();
                        return `
                        <button 
                          onclick="toggleExchangeCard(${idx})" 
                          class="p-3 rounded text-center transition-all ${
                            selectedExchangeCards.includes(idx) 
                              ? 'bg-teal-600 ring-4 ring-teal-400' 
                              : 'bg-gray-700 hover:bg-gray-600'
                          }"
                        >
                          <img src="${getCardImagePath(cardName)}" alt="${card.card || card}" class="w-full h-auto rounded mb-2" />
                          <div class="text-sm font-bold">
                            ${selectedExchangeCards.includes(idx) ? '‚úì Keep' : 'Click to keep'}
                          </div>
                        </button>
                      `}).join('')}
                    </div>
                    <div class="text-center mb-3">
                      <span class="text-teal-200">Selected: ${selectedExchangeCards.length}/${myPlayer.influences.length}</span>
                    </div>
                    <button 
                      onclick="completeExchange()" 
                      class="w-full bg-teal-600 hover:bg-teal-700 p-4 rounded font-bold ${
                        selectedExchangeCards.length !== myPlayer.influences.length ? 'opacity-50 cursor-not-allowed' : ''
                      }"
                      ${selectedExchangeCards.length !== myPlayer.influences.length ? 'disabled' : ''}
                    >
                      Confirm Exchange
                    </button>
                  </div>
                ` : ''}

                ${mustShowCard ? `
                  <div class="mb-6 bg-yellow-900 border-2 border-yellow-600 rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4 text-yellow-300">Choose a Card to Show</h3>
                    <p class="mb-4 text-yellow-100">You are being examined. Choose which card to show to the examiner.</p>
                    <div class="flex gap-3 justify-center">
                      ${myPlayer.influences.map((influence, idx) => `
                        ${!influence.revealed ? `
                          <button 
                            onclick="showCardToExaminer(${idx})" 
                            class="bg-yellow-600 hover:bg-yellow-700 p-4 rounded text-center flex-1 max-w-xs"
                          >
                            <img src="${getCardImagePath(influence.card)}" alt="${influence.card}" class="w-full h-auto rounded mb-2" />
                            <div class="text-sm font-bold">Show this card</div>
                          </button>
                        ` : ''}
                      `).join('')}
                    </div>
                  </div>
                ` : ''}

                ${mustExamine && examineTarget ? `
                  <div class="mb-6 bg-purple-900 border-2 border-purple-600 rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4 text-purple-300">Examine ${examineTarget.name}'s Card</h3>
                    ${myPlayer.examinedCard ? `
                      <p class="mb-4 text-purple-100">You see one of ${examineTarget.name}'s cards:</p>
                      <div class="bg-purple-800 rounded p-4 mb-4 text-center card-reveal max-w-xs mx-auto">
                        <img src="${getCardImagePath(myPlayer.examinedCard)}" alt="${myPlayer.examinedCard}" class="w-full h-auto rounded" />
                      </div>
                      <p class="mb-4 text-purple-100">Do you want to force ${examineTarget.name} to exchange this card for a new one from the deck?</p>
                      <div class="flex gap-3">
                        <button 
                          onclick="completeExamine(true)" 
                          class="flex-1 bg-red-600 hover:bg-red-700 p-4 rounded font-bold"
                        >
                          Force Exchange
                        </button>
                        <button 
                          onclick="completeExamine(false)" 
                          class="flex-1 bg-green-600 hover:bg-green-700 p-4 rounded font-bold"
                        >
                          Allow to Keep
                        </button>
                      </div>
                    ` : `
                      <p class="text-purple-100 text-center py-8">Waiting for ${examineTarget.name} to choose a card to show...</p>
                    `}
                  </div>
                ` : ''}

                ${isMyTurn && !actionInProgress && !mustReveal && !mustExchange && !mustExamine && !mustShowCard && myPlayer?.alive && !someoneRevealing && !someoneExchanging && !someoneExamining && !someoneShowingCard ? `
                  <div class="bg-gray-800 rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4 text-red-400">Your Turn - Choose Action</h3>
                    
                    ${selectedTarget ? `
                      <div class="mb-4 p-3 bg-gray-700 rounded">
                        <div class="flex justify-between items-center">
                          <span>Select target for ${selectedTarget}:</span>
                          <button onclick="selectedTarget = null; render()" class="text-red-400">Cancel</button>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mt-3">
                          ${players.filter(p => p.id !== myPlayerId && p.alive).map(player => `
                            <button onclick="performAction('${selectedTarget}', '${player.id}')" 
                              class="bg-gray-600 hover:bg-gray-500 p-3 rounded ${player.disconnected ? 'opacity-75' : ''}">
                              ${player.name} (${player.coins} üí∞)${player.disconnected ? ' ‚ö†Ô∏è¬è' : ''}
                            </button>
                          `).join('')}
                        </div>
                      </div>
                    ` : ''}
                    
                    <div class="grid grid-cols-2 gap-3">
                      <button onclick="performAction('income')" class="bg-gray-600 hover:bg-gray-700 p-3 rounded text-white">
                        Income (+1 üí∞)
                      </button>
                      <button onclick="performAction('foreignAid')" class="bg-gray-600 hover:bg-gray-700 p-3 rounded text-white">
                        Foreign Aid (+2 üí∞)
                      </button>
                      <button onclick="performAction('tax')" class="bg-duke p-3 rounded text-white">
                        Tax - Duke (+3 üí∞)
                      </button>
                      <button onclick="selectedTarget = 'steal'; render()" class="bg-captain p-3 rounded text-white">
                        Steal - Captain
                      </button>
                      <button onclick="performAction('exchange')" class="${useInquisitor ? 'bg-inquisitor' : 'bg-ambassador'} p-3 rounded text-white">
                        Exchange - ${useInquisitor ? 'Inquisitor' : 'Ambassador'}
                      </button>
                      ${useInquisitor ? `
                        <button onclick="selectedTarget = 'examine'; render()" class="bg-inquisitor p-3 rounded text-white">
                          Examine - Inquisitor
                        </button>
                      ` : '<div></div>'}
                      <button onclick="selectedTarget = 'assassinate'; render()" 
                        class="bg-assassin p-3 rounded text-white ${myPlayer.coins < 3 ? 'opacity-50 cursor-not-allowed' : ''}"
                        ${myPlayer.coins < 3 ? 'disabled' : ''}>
                        Assassinate (3 üí∞)
                      </button>
                      <button onclick="selectedTarget = 'coup'; render()" 
                        class="bg-red-900 hover:bg-red-950 p-3 rounded text-white ${!useInquisitor ? 'col-span-2' : ''} ${myPlayer.coins < 7 ? 'opacity-50 cursor-not-allowed' : ''}"
                        ${myPlayer.coins < 7 ? 'disabled' : ''}>
                        Coup (7 üí∞)
                      </button>
                    </div>
                    
                    ${myPlayer.coins >= 10 ? `
                      <div class="mt-4 p-3 bg-red-900 border border-red-700 rounded text-center">
                        You must Coup with 10+ coins!
                      </div>
                    ` : ''}
                  </div>
                ` : ''}

                ${!mustReveal && !mustExchange && !mustExamine && !mustShowCard && myPlayer?.alive && !isSpectator && (someoneRevealing || someoneExchanging || someoneExamining || someoneShowingCard) ? `
                  <div class="bg-gray-800 rounded-lg p-6 text-center">
                    <h3 class="text-xl font-bold mb-4 text-gray-400">Waiting...</h3>
                    ${someoneRevealing ? `
                      <p class="text-gray-300">${someoneRevealing.name} is choosing which influence to lose</p>
                    ` : someoneExchanging ? `
                      <p class="text-gray-300">${someoneExchanging.name} is exchanging cards</p>
                    ` : someoneExamining ? `
                      <p class="text-gray-300">${someoneExamining.name} is examining a card</p>
                    ` : someoneShowingCard ? `
                      <p class="text-gray-300">${someoneShowingCard.name} is choosing a card to show</p>
                    ` : ''}
                  </div>
                ` : !isMyTurn && !canIRespond && !canIChallengeBlock && !mustReveal && !mustExchange && !mustExamine && !mustShowCard && actionInProgress && actionInProgress.pausedForDisconnection && myPlayer?.alive && !isSpectator ? `
                  <div class="bg-yellow-900 border-2 border-yellow-600 rounded-lg p-6 text-center">
                    <h3 class="text-xl font-bold mb-4 text-yellow-300">‚è∏Ô∏è Action Paused</h3>
                    <p class="text-yellow-100">Waiting for disconnected player(s) to reconnect...</p>
                  </div>
                ` : !isMyTurn && !mustReveal && !mustExchange && !mustExamine && !mustShowCard && !actionInProgress && myPlayer?.alive && !isSpectator && players[currentPlayerId]?.disconnected ? `
                  <div class="bg-yellow-900 border-2 border-yellow-600 rounded-lg p-6 text-center">
                    <h3 class="text-xl font-bold mb-4 text-yellow-300">‚ö†Ô∏è¬è Game Paused</h3>
                    <p class="text-yellow-100">${players.find(p => p.id === currentPlayerId)?.name} is disconnected</p>
                    <p class="text-yellow-200 text-sm mt-2">Waiting for them to reconnect...</p>
                  </div>
                ` : ''}

                ${isSpectator ? `
                  <div class="bg-blue-900 border-2 border-blue-600 rounded-lg p-6 text-center">
                    <div class="text-2xl mb-2">üëÅÔ∏è</div>
                    <div class="text-xl font-bold text-blue-300 mb-2">Spectating</div>
                    <div class="text-blue-200 text-sm">You're watching the game</div>
                  </div>
                ` : ''}
              </div>

              <div>
                <div id="gameLogContainer" class="bg-gray-800 rounded-lg px-4 pb-4 h-[600px] overflow-y-auto mb-4" onscroll="checkScrollPosition()">
                  <div class="flex justify-between items-center mb-3 sticky top-0 bg-gray-800 pb-2 pt-4 border-b border-gray-700 z-50">
                    <div class="flex items-center gap-2">
                      <h3 class="font-bold">Game Log</h3>
                      <div class="flex gap-1">
                        <button 
                          onclick="toggleActionsFilter()" 
                          class="text-xs px-2 py-1 rounded transition-colors ${showAllActions ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-600 hover:bg-gray-500'}"
                          title="${showAllActions ? 'Showing all actions' : 'Showing only my actions'}"
                        >
                          ${showAllActions ? 'üë•' : 'üë§'}
                        </button>
                        <button 
                          onclick="toggleChatFilter()" 
                          class="text-xs px-2 py-1 rounded transition-colors ${showChat ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-600 hover:bg-gray-500'}"
                          title="${showChat ? 'Chat visible' : 'Chat hidden'}"
                        >
                          üí¨
                        </button>
                        ${allowSpectators ? `
                          <button 
                            onclick="toggleSpectatorChatFilter()" 
                            class="text-xs px-2 py-1 rounded transition-colors ${showSpectatorChat ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-600 hover:bg-gray-500'}"
                            title="${showSpectatorChat ? 'Spectator chat visible' : 'Spectator chat hidden'}"
                          >
                            üëÅÔ∏è
                          </button>
                        ` : ''}
                      </div>
                    </div>
                    <div class="text-sm text-gray-400">
                      <span class="font-bold text-white">${deckSize}</span> cards in deck
                    </div>
                  </div>
                  <div class="space-y-2">
                    ${gameLog.filter(log => {
                      // Filter chat messages
                      if (log.type === 'chat') {
                        if (!showChat) return false;
                        if (log.isSpectator && !showSpectatorChat) return false;
                        return true;
                      }
                      
                      // Filter action messages (only if not showing all actions)
                      if (!showAllActions) {
                        const myPlayer = players.find(p => p.isMe);
                        if (!myPlayer) return true; // Show all if can't determine "me"
                        
                        const myName = myPlayer.name;
                        const message = log.message;
                        
                        // Always show general game events (no player name, or special messages)
                        if (message.startsWith('---') || 
                            message.startsWith('üéâ') || 
                            message.includes('wins the game') ||
                            message.includes('Game started') ||
                            message.includes('joined') ||
                            message.includes('disconnected') ||
                            message.includes('left the game')) {
                          return true;
                        }
                        
                        // Show if message involves my name
                        if (message.includes(myName)) return true;
                        
                        // Hide other players' actions
                        return false;
                      }
                      
                      return true;
                    }).map(log => {
                      if (log.type === 'chat') {
                        // Chat message styling
                        const isSpectatorChat = log.isSpectator;
                        const chatColor = isSpectatorChat ? 'border-blue-500' : 'border-green-500';
                        const badge = isSpectatorChat ? '<span class="text-xs bg-blue-600 px-1 rounded">SPEC</span>' : '';
                        return `
                          <div class="text-sm text-white border-l-2 ${chatColor} pl-3 py-1 rounded-r">
                            <span class="font-bold">${log.playerName}</span> ${badge}: ${log.message}
                          </div>
                        `;
                      } else {
                        // Game log styling
                        const style = getLogStyle(log);
                        const highlighted = highlightCharactersInLog(log.message);
                        return `
                          <div class="text-sm ${style.textColor} ${style.bgColor} pl-3 py-1 rounded">
                            ${highlighted}
                          </div>
                        `;
                      }
                    }).join('')}
                  </div>
                </div>

                <!-- Chat Input -->
                ${chatMode !== 'none' ? `
                  <div class="bg-gray-800 rounded-lg p-3">
                    <form onsubmit="sendChatMessage(event)" class="flex gap-2">
                      <input 
                        type="text" 
                        id="chatInput"
                        placeholder="${chatMode === 'separate' ? (isSpectator ? 'Chat with spectators...' : 'Chat with players...') : 'Chat with everyone...'}"
                        class="flex-1 p-2 bg-gray-700 rounded border border-gray-600 text-white text-sm"
                        maxlength="200"
                      />
                      <button 
                        type="submit"
                        class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-sm font-bold"
                      >
                        Send
                      </button>
                    </form>
                  </div>
                ` : ''}

                ${spectators.length > 0 ? `
                  <div class="bg-gray-800 rounded-lg p-4">
                    <h3 class="font-bold mb-3">Spectators (${spectators.length})</h3>
                    <div class="space-y-2">
                      ${spectators.map(spectator => `
                        <div class="text-sm text-gray-300 flex items-center gap-2">
                          <span class="text-blue-500">üëÅÔ∏è</span>
                          <span>${spectator.name}</span>
                          ${spectator.isMe ? '<span class="text-xs bg-blue-600 px-2 py-1 rounded ml-auto">YOU</span>' : ''}
                        </div>
                      `).join('')}
                    </div>
                  </div>
                ` : ''}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderEndGame() {
      console.log('renderEndGame called, gameStats:', gameStats);
      const winner = players.find(p => p.alive);
      console.log('Winner:', winner);
      
      // If we have game stats, show the full leaderboard
      if (gameStats && gameStats.length > 0) {
        console.log('Rendering leaderboard with stats');
        return `
          <div class="min-h-screen bg-gradient-to-br from-red-900 via-gray-900 to-black text-white p-8">
            <div class="max-w-4xl mx-auto">
              <!-- Header -->
              <div class="text-center mb-8">
                <h1 class="text-5xl font-bold mb-4">üéâ Game Over! üéâ</h1>
                <p class="text-3xl text-yellow-400 mb-2">${winner?.name || gameStats[0].playerName} Wins!</p>
                ${isSpectator ? `<p class="text-blue-400 text-lg">You were spectating</p>` : ''}
              </div>

              <!-- Leaderboard -->
              <div class="bg-gray-800 rounded-lg shadow-2xl overflow-hidden mb-6">
                <div class="bg-gradient-to-r from-yellow-600 to-yellow-800 p-4">
                  <h2 class="text-2xl font-bold text-center">Final Standings</h2>
                </div>
                
                <div class="p-6">
                  ${gameStats.map((player, index) => {
                    const isWinner = player.placement === 1;
                    const placementColors = {
                      1: 'from-yellow-600 to-yellow-800',
                      2: 'from-gray-400 to-gray-600',
                      3: 'from-orange-600 to-orange-800'
                    };
                    const bgGradient = placementColors[player.placement] || 'from-gray-700 to-gray-800';
                    
                    const placementEmoji = {
                      1: 'ü•á',
                      2: 'ü•à',
                      3: 'ü•â'
                    };
                    const emoji = placementEmoji[player.placement] || `${player.placement}th`;
                    
                    return `
                      <div class="mb-4 last:mb-0">
                        <div class="bg-gradient-to-r ${bgGradient} rounded-lg p-4 ${isWinner ? 'ring-4 ring-yellow-400 shadow-lg' : ''}">
                          <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4 flex-1">
                              <div class="text-3xl font-bold w-12 text-center">${emoji}</div>
                              <div class="flex-1">
                                <div class="text-xl font-bold">
                                  ${player.username 
                                    ? `<a href="/profile.html?user=${encodeURIComponent(player.username)}" class="hover:text-blue-300 hover:underline">${player.playerName}</a>`
                                    : player.playerName
                                  }
                                </div>
                                <div class="text-sm text-gray-300 mt-1">
                                  ${player.placement === 1 ? 'Winner' : `Eliminated ${player.placement === gameStats.length ? 'First' : ''}`}
                                </div>
                              </div>
                            </div>
                            
                            <div class="flex gap-6 text-center">
                              <div class="bg-black bg-opacity-30 rounded px-4 py-2">
                                <div class="text-2xl font-bold text-yellow-400">${player.coinsEarned}</div>
                                <div class="text-xs text-gray-300">Coins Earned</div>
                              </div>
                              <div class="bg-black bg-opacity-30 rounded px-4 py-2">
                                <div class="text-2xl font-bold text-red-400">${player.eliminations}</div>
                                <div class="text-xs text-gray-300">Eliminations</div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>

              <!-- Buttons -->
              <div class="text-center flex gap-4 justify-center">
                <button onclick="playAgain()" class="bg-green-600 hover:bg-green-700 px-8 py-4 rounded-lg text-xl font-bold shadow-lg transition-colors">
                  üéÆ Play Again!
                </button>
                <button onclick="leaveRoom()" class="bg-red-600 hover:bg-red-700 px-8 py-4 rounded-lg text-xl font-bold shadow-lg transition-colors">
                  Back to Lobby
                </button>
              </div>
            </div>
          </div>
        `;
      }
      
      // Fallback if no game stats available
      return `
        <div class="min-h-screen bg-gradient-to-br from-red-900 via-gray-900 to-black text-white flex items-center justify-center">
          <div class="bg-gray-800 rounded-lg p-12 text-center max-w-md">
            <h1 class="text-4xl font-bold mb-4">Game Over!</h1>
            <p class="text-2xl mb-8 text-red-400">${winner?.name} wins!</p>
            ${isSpectator ? `
              <p class="text-blue-400 mb-4">You were spectating</p>
            ` : ''}
            <div class="flex gap-4">
              <button onclick="playAgain()" class="bg-green-600 hover:bg-green-700 p-4 rounded text-xl font-bold flex-1">
                üéÆ Play Again!
              </button>
              <button onclick="leaveRoom()" class="bg-red-600 hover:bg-red-700 p-4 rounded text-xl font-bold flex-1">
                Back to Lobby
              </button>
            </div>
          </div>
        </div>
      `;
    }

    window.onload = async () => {
      // Verify auth token first
      await verifyAuthToken();
      
      // Then initialize socket
      initSocket();
      
      // Check if coming from lobby with a join code
      const lobbyJoinCode = localStorage.getItem('coupJoinCode');
      
      if (lobbyJoinCode) {
        // Clear the stored value
        localStorage.removeItem('coupJoinCode');

        const storedRoomCode = localStorage.getItem('coupCurrentRoom');
        if (lobbyJoinCode === storedRoomCode) {
          // This is a rejoin ‚Äî the connect handler's attemptReconnect will handle it.
          // Just wait here; don't show the preview or we'll end up with only "Watch".
        } else {
          // Fresh join ‚Äî show preview so user can choose player or spectator
          joinCode = lobbyJoinCode;
          
          const checkSocket = setInterval(() => {
            if (socket && socket.connected) {
              clearInterval(checkSocket);
              
              socket.emit('previewRoom', { roomCode: lobbyJoinCode }, (response) => {
                if (response.success) {
                  previewMode = true;
                  previewRoomCode = lobbyJoinCode;
                  previewData = response.roomData;
                  players = previewData.players;
                  spectators = previewData.spectators;
                  useInquisitor = previewData.useInquisitor;
                  allowSpectators = previewData.allowSpectators;
                  chatMode = previewData.chatMode || 'separate';
                  gameState = 'lobby';
                  render();
                } else {
                  alert('Room not found: ' + lobbyJoinCode);
                }
              });
            }
          }, 100);
        }
      } else if (localStorage.getItem('coupGameSettings')) {
        // Coming from create-game.html - auto-create the room
        const checkSocket = setInterval(() => {
          if (socket && socket.connected) {
            clearInterval(checkSocket);
            createRoom();
          }
        }, 100);
      } else {
        // No join code or settings - redirect back to lobby
        window.location.href = '/lobby.html';
      }
    };
  </script>
</body>
</html>