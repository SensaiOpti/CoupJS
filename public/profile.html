<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Player Profile - Coup</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
      background: linear-gradient(to bottom right, #7f1d1d, #1f2937, #000000);
      min-height: 100vh;
    }
    
    .stat-card {
      background: rgba(31, 41, 55, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(75, 85, 99, 0.3);
      transition: all 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-2px);
      border-color: rgba(239, 68, 68, 0.5);
      box-shadow: 0 10px 30px rgba(239, 68, 68, 0.2);
    }
    
    .progress-bar {
      transition: width 1s ease-out;
    }
    
    /* Toggle switch */
    input:checked ~ .toggle-bg { background: linear-gradient(to right, #3b82f6, #a855f7); }
    input:checked ~ .toggle-dot { transform: translateX(16px); }
    
    .match-item {
      transition: all 0.2s ease;
    }
    
    .match-item:hover {
      background: rgba(55, 65, 81, 0.6);
      transform: translateX(5px);
    }
    
    .placement-1 { border-left: 4px solid #fbbf24; }
    .placement-2 { border-left: 4px solid #9ca3af; }
    .placement-3 { border-left: 4px solid #d97706; }
    .placement-other { border-left: 4px solid #374151; }
    
    /* Character colors */
    .bg-ambassador { background-color: #5a7d62; }
    .bg-assassin { background-color: #2a2a2a; }
    .bg-captain { background-color: #2A5088; }
    .bg-contessa { background-color: #901E21; }
    .bg-duke { background-color: #432762; }
    .bg-inquisitor { background-color: #D1A819; }
    
    .skeleton {
      background: linear-gradient(90deg, #374151 25%, #4b5563 50%, #374151 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }
    
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
  </style>
</head>
<body class="text-white">
  <div class="max-w-7xl mx-auto p-4 md:p-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
      <h1 class="text-4xl font-bold text-red-500">COUP</h1>
      <div class="flex gap-3">
        <a href="/leaderboards.html" class="bg-blue-700 hover:bg-blue-600 px-4 py-2 rounded transition-colors">
          Leaderboards
        </a>
        <a id="settingsBtn" href="/settings.html" class="hidden bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded transition-colors">
          Settings
        </a>
        <a href="/" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded transition-colors">
          Back to Lobby
        </a>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="text-center py-20">
      <div class="text-6xl mb-4">‚è≥</div>
      <div class="text-2xl">Loading profile...</div>
    </div>

    <!-- Error State -->
    <div id="error" class="hidden bg-red-900 border border-red-600 rounded-lg p-8 text-center">
      <div class="text-6xl mb-4">‚ùå</div>
      <div class="text-2xl mb-4">Error Loading Profile</div>
      <div id="errorMessage" class="text-gray-300 mb-4"></div>
      <button onclick="window.location.href='/'" class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded">
        Back to Game
      </button>
    </div>

    <!-- Profile Content -->
    <div id="profile" class="hidden">
      <!-- Header Section -->
      <div class="stat-card rounded-lg p-8 mb-6">
        <div class="flex flex-col md:flex-row items-center md:items-start gap-6">
          <!-- Avatar -->
          <div class="w-32 h-32 bg-gray-700 rounded-full flex items-center justify-center text-6xl">
            üë§
          </div>
          
          <!-- User Info -->
          <div class="flex-1 text-center md:text-left">
            <h2 id="username" class="text-4xl font-bold mb-2"></h2>
            <div id="playstyle" class="text-2xl mb-3"></div>
            <div id="memberSince" class="text-gray-400 text-sm mb-4"></div>
            
            <!-- Elo and Games Stats -->
            <div class="flex gap-6 justify-center md:justify-start mt-4">
              <div>
                <div class="text-gray-400 text-xs uppercase mb-1">Games Played</div>
                <div id="gamesPlayedHeader" class="text-3xl font-bold text-blue-400"></div>
              </div>
              <div>
                <div class="text-gray-400 text-xs uppercase mb-1">Elo Rating</div>
                <div id="eloHeader" class="text-3xl font-bold text-yellow-500"></div>
              </div>
            </div>
          </div>
          
          <!-- Bio (if present) -->
          <div id="bioContainer" class="hidden md:max-w-md md:self-center">
            <div class="border-2 border-gray-700 rounded-lg p-4 bg-gray-800/30">
              <div id="bioText" class="text-gray-300 text-lg italic leading-relaxed"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Core Stats -->
      <div id="privateContent" class="hidden">

      <div id="winRateSection" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <!-- Win Rate -->
        <div class="stat-card rounded-lg p-6 text-center">
          <div class="text-gray-400 text-sm mb-2">WIN RATE</div>
          <div id="winRate" class="text-5xl font-bold text-green-500 mb-2"></div>
          <div id="winRecord" class="text-sm text-gray-400"></div>
          <div class="w-full bg-gray-700 rounded-full h-2 mt-3">
            <div id="winRateBar" class="progress-bar bg-green-500 h-2 rounded-full"></div>
          </div>
        </div>
        
        <!-- K/D Ratio -->
        <div class="stat-card rounded-lg p-6 text-center">
          <div class="text-gray-400 text-sm mb-2">K/D RATIO</div>
          <div id="kdRatio" class="text-5xl font-bold text-red-500 mb-2"></div>
          <div id="kdDetails" class="text-sm text-gray-400"></div>
        </div>
      </div>

      <!-- Individual Stats Grid -->
      <div id="individualStatsSection" class="stat-card rounded-lg p-6 mb-6">
        <h3 class="text-2xl font-bold mb-4 flex items-center gap-2">
          <span>üìä</span>
          <span>Individual Stats</span>
        </h3>
        <div id="featuredStats" class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <!-- Dynamically populated -->
        </div>
      </div>

      <!-- Achievements -->
      <div class="stat-card rounded-lg p-6 mb-6" id="achievementsSection">
        <div class="flex flex-col md:flex-row md:items-start justify-between gap-3 mb-4">
          <div>
            <h3 class="text-2xl font-bold flex items-center gap-2">
              <span>üèÜ</span>
              <span>Achievements</span>
            </h3>
            <div id="achievementCompletion" class="text-sm text-gray-400 mt-1"></div>
          </div>
          <div class="flex gap-3 text-sm">
            <label class="flex items-center gap-2 cursor-pointer select-none">
              <div class="relative">
                <input type="checkbox" id="toggleUnlocked" class="sr-only" checked>
                <div class="w-9 h-5 bg-gray-600 rounded-full toggle-bg transition-colors"></div>
                <div class="absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full toggle-dot transition-transform"></div>
              </div>
              <span class="text-gray-300">Show unlocked</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer select-none">
              <div class="relative">
                <input type="checkbox" id="toggleLaterTiers" class="sr-only">
                <div class="w-9 h-5 bg-gray-600 rounded-full toggle-bg transition-colors"></div>
                <div class="absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full toggle-dot transition-transform"></div>
              </div>
              <span class="text-gray-300">Show later tiers</span>
            </label>
          </div>
        </div>
        <div id="achievements" class="grid grid-cols-2 md:grid-cols-5 gap-4">
          <!-- Dynamically populated -->
        </div>
      </div>

      <!-- Match History -->
      <div id="matchHistorySection" class="stat-card rounded-lg p-6">
        <h3 class="text-2xl font-bold mb-4 flex items-center gap-2">
          <span>üìú</span>
          <span>Recent Matches</span>
        </h3>
        <div id="matchHistory" class="space-y-3">
          <!-- Dynamically populated -->
        </div>
        <div id="noMatches" class="hidden text-center py-8 text-gray-400">
          No matches played yet. Start your first game!
        </div>
      </div>

      </div> <!-- end privateContent -->

      <!-- Visitor message -->
      <div id="visitorMessage" class="hidden stat-card rounded-lg p-8 text-center">
        <div class="text-4xl mb-3">üîí</div>
        <div class="text-lg font-bold text-gray-300 mb-2">Stats are private</div>
        <div class="text-sm text-gray-400">Only this player can view their full stats, achievements, and match history.</div>
      </div>
    </div>
  </div>

  <script>
    // Get username from URL or use default
    const urlParams = new URLSearchParams(window.location.search);
    const username = urlParams.get('user') || localStorage.getItem('currentUsername') || 'guest';
    
    const API_BASE = window.location.origin;

    async function loadProfile() {
      try {
        // Fetch profile data
        const profileRes = await fetch(`${API_BASE}/api/profile/${username}`);
        if (!profileRes.ok) {
          throw new Error('Profile not found');
        }
        const profileData = await profileRes.json();
        
        // Fetch match history
        const matchesRes = await fetch(`${API_BASE}/api/profile/${username}/matches?limit=10`);
        const matchesData = await matchesRes.json();
        
        // Hide loading, show profile
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('profile').classList.remove('hidden');
        
        // Render profile
        renderProfile(profileData, matchesData);
        
      } catch (error) {
        console.error('Error loading profile:', error);
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('error').classList.remove('hidden');
        document.getElementById('errorMessage').textContent = error.message;
      }
    }

    function renderProfile(data, matches) {
      const { user, stats, rank, playstyle, achievements } = data;
      const privacy = data.privacy || {};
      
      // Check if this is the current user's profile
      const currentUserData = authToken ? JSON.parse(localStorage.getItem('currentUser') || '{}') : {};
      isMyProfile = currentUserData.username === user.username;
      
      // Show settings button for profile owner
      if (isMyProfile) {
        document.getElementById('settingsBtn').classList.remove('hidden');
      }
      
      // User info
      document.getElementById('username').textContent = user.username;
      document.getElementById('playstyle').textContent = `${playstyle.icon} ${playstyle.name}`;
      document.getElementById('playstyle').title = playstyle.description;
      
      const joinDate = new Date(user.createdAt).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
      document.getElementById('memberSince').textContent = `Playing since ${joinDate}`;
      
      // Header stats
      document.getElementById('eloHeader').textContent = stats.elo_rating;
      document.getElementById('gamesPlayedHeader').textContent = stats.games_played;
      
      // Bio
      if (user.bio && user.bio.trim()) {
        document.getElementById('bioText').textContent = user.bio;
        document.getElementById('bioContainer').classList.remove('hidden');
      }
      
      // Core stats
      document.getElementById('winRate').textContent = `${stats.win_rate}%`;
      document.getElementById('winRecord').textContent = `${stats.games_won}W - ${stats.games_played - stats.games_won}L`;
      document.getElementById('winRateBar').style.width = `${stats.win_rate}%`;
      
      document.getElementById('kdRatio').textContent = stats.kd_ratio;
      document.getElementById('kdDetails').textContent = `${stats.players_eliminated} Kills / ${stats.influences_lost} Deaths`;
      
      // Featured stats
      renderFeaturedStats(stats);
      
      // Determine what's visible to visitors based on privacy settings
      const canSeeAll = isMyProfile;
      const canSeeIndividualStats = canSeeAll || privacy.showIndividualStats;
      const canSeeWinRate = canSeeAll || privacy.showWinRate;
      const canSeeAchievements = canSeeAll || privacy.showAchievements;
      const canSeeMatchHistory = canSeeAll || privacy.showMatchHistory;
      
      if (isMyProfile) {
        document.getElementById('privateContent').classList.remove('hidden');
        // Hide sections that aren't applicable for visitor view
        document.getElementById('winRateSection').classList.toggle('hidden', false);
        document.getElementById('individualStatsSection').classList.toggle('hidden', false);
        document.getElementById('achievementsSection').classList.toggle('hidden', false);
        document.getElementById('matchHistorySection').classList.toggle('hidden', false);
      } else {
        // Show the private wrapper
        document.getElementById('privateContent').classList.remove('hidden');
        // Selectively show/hide based on privacy
        document.getElementById('winRateSection').classList.toggle('hidden', !canSeeWinRate);
        document.getElementById('individualStatsSection').classList.toggle('hidden', !canSeeIndividualStats);
        document.getElementById('achievementsSection').classList.toggle('hidden', !canSeeAchievements);
        document.getElementById('matchHistorySection').classList.toggle('hidden', !canSeeMatchHistory);
        // Show visitor message only if everything is hidden
        if (!canSeeIndividualStats && !canSeeWinRate && !canSeeAchievements && !canSeeMatchHistory) {
          document.getElementById('visitorMessage').classList.remove('hidden');
          document.getElementById('privateContent').classList.add('hidden');
        }
      }

      // Achievements - always show section now
      // Store achievements globally for re-rendering on toggle
      window.allAchievements = achievements;
      renderAchievements(achievements);
      
      // Set up toggle listeners
      document.getElementById('toggleUnlocked').addEventListener('change', () => renderAchievements(window.allAchievements));
      document.getElementById('toggleLaterTiers').addEventListener('change', () => renderAchievements(window.allAchievements));
      
      // Match history
      renderMatchHistory(matches.matches);
    }

    function renderFeaturedStats(stats) {
      // Calculate total actions blocked
      const actionsBlocked = (stats.steals_blocked || 0) + (stats.contessa_succeeded || 0) + (stats.foreignaidblock_succeeded || 0);
      
      const featuredStats = [
        { label: 'Coins Earned', value: stats.coins_earned.toLocaleString(), icon: 'üí∞' },
        { label: 'Assassinations Succeeded', value: stats.assassinations_succeeded, icon: '‚öîÔ∏è' },
        { label: 'Contessa Saves Succeeded', value: stats.contessa_succeeded, icon: 'üõ°Ô∏è' },
        { label: 'Exchanges Succeeded', value: stats.influence_exchanged, icon: 'üîÑ' },
        { label: 'Examinations Succeeded', value: stats.influence_examined, icon: 'üîç' },
        { label: 'Stealing Succeeded', value: stats.coins_stolen, icon: 'üí∏' },
        { label: 'Taxes Succeeded', value: stats.tax_succeeded, icon: 'üíé' },
        { label: 'Coups Enacted', value: stats.coups_enacted, icon: 'üëä' },
        { label: 'Income Taken', value: stats.income_taken, icon: 'ü™ô' },
        { label: 'Bluffs Succeeded', value: stats.bluffs_succeeded, icon: 'üé≠' },
        { label: 'Challenges Won', value: stats.successful_challenges, icon: '‚úì' },
        { label: 'Actions Blocked', value: actionsBlocked, icon: 'üö´' }
      ];
      
      const container = document.getElementById('featuredStats');
      container.innerHTML = featuredStats.map(stat => `
        <div class="bg-gray-700 rounded-lg p-4 text-center hover:bg-gray-600 transition-colors">
          <div class="text-3xl mb-2">${stat.icon}</div>
          <div class="text-2xl font-bold text-white mb-1">${stat.value}</div>
          <div class="text-xs text-gray-400">${stat.label}</div>
        </div>
      `).join('');
    }

    function filterAchievementTiers(achievements) {
      // Group achievements by icon AND progress value (same series will have same current progress)
      const grouped = {};
      
      achievements.forEach(achievement => {
        const key = `${achievement.icon}_${achievement.progress}`;
        if (!grouped[key]) {
          grouped[key] = [];
        }
        grouped[key].push(achievement);
      });
      
      // For each group, keep unlocked achievements and only the next locked tier
      const filtered = [];
      
      Object.values(grouped).forEach(group => {
        // Sort by target ascending
        group.sort((a, b) => a.target - b.target);
        
        // For groups with multiple achievements, check if it's a tier series
        // A tier series has 2+ achievements with increasing targets
        const isTierSeries = group.length >= 2;
        
        if (isTierSeries) {
          // Add all unlocked achievements
          const unlocked = group.filter(a => a.unlocked);
          filtered.push(...unlocked);
          
          // Find the first locked achievement (next tier to unlock)
          const locked = group.filter(a => !a.unlocked);
          if (locked.length > 0) {
            filtered.push(locked[0]); // Add only the first locked one
          }
        } else {
          // Not a tier series (standalone achievement), show all
          filtered.push(...group);
        }
      });
      
      return filtered;
    }

    function renderAchievements(achievements) {
      const container = document.getElementById('achievements');
      const showUnlocked = document.getElementById('toggleUnlocked').checked;
      const showLaterTiers = document.getElementById('toggleLaterTiers').checked;
      
      // Calculate total completion stats (always from full list)
      const totalCount = achievements.length;
      const unlockedCount = achievements.filter(a => a.unlocked).length;
      const completionPct = totalCount > 0 ? Math.round((unlockedCount / totalCount) * 100) : 0;
      document.getElementById('achievementCompletion').textContent = `${unlockedCount} of ${totalCount} (${completionPct}%)`;
      
      // Apply tier filtering based on toggle
      let filteredAchievements = showLaterTiers ? achievements : filterAchievementTiers(achievements);
      
      // Apply unlocked filter
      if (!showUnlocked) {
        filteredAchievements = filteredAchievements.filter(a => !a.unlocked);
      }
      
      container.innerHTML = filteredAchievements.map(achievement => {
        const percentage = Math.min(100, Math.round((achievement.progress / achievement.target) * 100));
        const isUnlocked = achievement.unlocked;
        
        // Build additional info text (only shown for locked achievements)
        let additionalInfo = '';
        if (achievement.id === 'sharpshooter') {
          additionalInfo = `<div class="text-xs text-gray-300 mt-1">${achievement.accuracy}% accuracy</div>`;
        } else if (achievement.id === 'untouchable') {
          additionalInfo = `<div class="text-xs text-gray-300 mt-1">${achievement.avgInfluences} avg influences lost</div>`;
        }
        
        const unlockedDate = achievement.unlockedAt 
          ? new Date(achievement.unlockedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })
          : null;
        
        return `
          <div class="${isUnlocked ? 'badge' : 'bg-gray-700 hover:scale-105'} rounded-lg p-4 text-center transition-transform cursor-pointer relative overflow-hidden" 
               style="${isUnlocked ? 'background: linear-gradient(to bottom right, #3b82f6, #a855f7);' : ''}"
               title="${achievement.description}">
            ${!isUnlocked ? `
              <div class="absolute inset-0 bg-gradient-to-r from-blue-600 to-purple-600 opacity-30" style="width: ${percentage}%"></div>
            ` : ''}
            <div class="relative z-10">
              <div class="text-4xl mb-2 ${!isUnlocked ? 'opacity-50' : ''}">${achievement.icon}</div>
              <div class="text-sm font-bold ${!isUnlocked ? 'text-gray-300' : ''}">${achievement.name}</div>
              <div class="text-xs text-gray-300 italic mt-1">${achievement.description}</div>
              ${!isUnlocked ? `
                <div class="mt-2">
                  <div class="text-xs text-gray-400 mb-1">${achievement.progress} / ${achievement.target}</div>
                  <div class="w-full bg-gray-600 rounded-full h-2">
                    <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full transition-all" style="width: ${percentage}%"></div>
                  </div>
                  <div class="text-xs text-gray-400 mt-1">${percentage}%</div>
                </div>
                ${additionalInfo}
              ` : `
                <div class="text-xs text-green-300 mt-2">‚úì Unlocked${unlockedDate ? ` on ${unlockedDate}` : ''}</div>
              `}
            </div>
          </div>
        `;
      }).join('');
    }

    function renderMatchHistory(matches) {
      const container = document.getElementById('matchHistory');
      const noMatches = document.getElementById('noMatches');
      
      if (!matches || matches.length === 0) {
        container.classList.add('hidden');
        noMatches.classList.remove('hidden');
        return;
      }
      
      container.innerHTML = matches.map(match => {
        const date = new Date(match.endedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const time = new Date(match.endedAt).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        const placementClass = match.placement === 1 ? 'placement-1' : 
                               match.placement === 2 ? 'placement-2' : 
                               match.placement === 3 ? 'placement-3' : 'placement-other';
        const placementEmoji = match.placement === 1 ? 'ü•á' : 
                              match.placement === 2 ? 'ü•à' : 
                              match.placement === 3 ? 'ü•â' : 'üíÄ';
        const eloChangeValue = typeof match.eloChange === 'object' && match.eloChange !== null 
          ? match.eloChange.change 
          : (match.eloChange || 0);
        const eloColor = eloChangeValue > 0 ? 'text-green-400' : 
                        eloChangeValue < 0 ? 'text-red-400' : 'text-gray-400';
        
        return `
          <div class="match-item ${placementClass} bg-gray-700 rounded-lg p-4">
            <div class="flex flex-col md:flex-row md:items-center gap-3">
              <!-- Placement -->
              <div class="flex items-center gap-3 flex-1">
                <div class="text-3xl">${placementEmoji}</div>
                <div>
                  <div class="font-bold text-lg">
                    ${match.placement === 1 ? '1st Place' : 
                      match.placement === 2 ? '2nd Place' : 
                      match.placement === 3 ? '3rd Place' : 
                      `${match.placement}th Place`}
                    ${eloChangeValue !== 0 ? `<span class="${eloColor} font-bold">(${eloChangeValue > 0 ? '+' : ''}${eloChangeValue})</span>` : ''}
                  </div>
                  <div class="text-sm text-gray-300">Players: ${match.totalPlayers}</div>
                  <div class="text-sm text-gray-400">${date} at ${time}</div>
                </div>
              </div>
              
              <!-- Quick Stats -->
              <div class="grid grid-rows-2 gap-2 text-xs" style="grid-auto-flow: column;">
                ${match.stats.coinsEarned ? `<span class="bg-yellow-700 px-2 py-1 rounded">ü™ô ${match.stats.coinsEarned} coins earned</span>` : ''}
                ${match.stats.playersEliminated ? `<span class="bg-red-900 px-2 py-1 rounded">üó°Ô∏è ${match.stats.playersEliminated} eliminations</span>` : ''}
                ${match.stats.bluffsSucceeded ? `<span class="bg-purple-900 px-2 py-1 rounded">üé≠ ${match.stats.bluffsSucceeded} bluffs</span>` : ''}
                ${match.stats.coinsStolen ? `<span class="bg-captain px-2 py-1 rounded">üí∞ ${match.stats.coinsStolen} stolen</span>` : ''}
                ${match.stats.influencesLost ? `<span class="bg-gray-700 px-2 py-1 rounded">üíÄ ${match.stats.influencesLost} lost</span>` : ''}
                ${match.stats.taxSucceeded ? `<span class="bg-duke px-2 py-1 rounded">üíé ${match.stats.taxSucceeded} tax</span>` : ''}
                ${match.stats.assassinationsSucceeded ? `<span class="bg-assassin px-2 py-1 rounded">‚öîÔ∏è ${match.stats.assassinationsSucceeded} assassinations</span>` : ''}
                ${match.stats.coupsEnacted ? `<span class="bg-red-800 px-2 py-1 rounded">üëë ${match.stats.coupsEnacted} coups</span>` : ''}
                ${match.stats.influenceExchanged ? `<span class="bg-inquisitor px-2 py-1 rounded">üîÑ ${match.stats.influenceExchanged} exchanges</span>` : ''}
                ${match.stats.influenceExamined ? `<span class="bg-inquisitor px-2 py-1 rounded">üîç ${match.stats.influenceExamined} examinations</span>` : ''}
                ${match.stats.contessaSucceeded ? `<span class="bg-contessa px-2 py-1 rounded">üõ°Ô∏è ${match.stats.contessaSucceeded} assassination blocks</span>` : ''}
                ${match.stats.stealsBlocked ? `<span class="bg-ambassador px-2 py-1 rounded">üõ°Ô∏è ${match.stats.stealsBlocked} steal blocks</span>` : ''}
                ${match.stats.foreignaidblockSucceeded ? `<span class="bg-duke px-2 py-1 rounded">üõ°Ô∏è ${match.stats.foreignaidblockSucceeded} foreign aid blocks</span>` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    let authToken = localStorage.getItem('coupAuthToken');
    let isMyProfile = false;

    // Load profile on page load
    loadProfile();
    
    // Socket.io connection for online user tracking
    const socketScript = document.createElement('script');
    socketScript.src = '/socket.io/socket.io.js';
    socketScript.onload = () => {
      const authToken = localStorage.getItem('coupAuthToken');
      const socket = io({
        auth: { token: authToken }
      });
      
      socket.on('connect', () => {
        // For guests, get username from localStorage
        const guestUsername = localStorage.getItem('coupGuestUsername');
        // Server will use authenticatedUser.username if token is valid, otherwise uses this
        socket.emit('joinLobby', { username: guestUsername });
      });
    };
    document.head.appendChild(socketScript);
  </script>
</body>
</html>