<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Coup</title>
  <script src="/profanity-filter.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(to bottom right, #7f1d1d, #1f2937, #000000);
      min-height: 100vh;
    }
    
    .stat-card {
      background: rgba(31, 41, 55, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(75, 85, 99, 0.3);
    }
    
    #chatMessages {
      scroll-behavior: smooth;
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Toggle switch styles */
    #showOnlyOnline:checked ~ .toggle-bg {
      background: linear-gradient(135deg, #3b82f6 0%, #a855f7 100%);
    }
    
    #showOnlyOnline:checked ~ .toggle-dot {
      transform: translateX(20px);
    }
  </style>
</head>
<body class="text-white">
  <div class="max-w-7xl mx-auto p-4 md:p-8">

    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
      <div class="flex items-center gap-4">
        <h1 class="text-4xl font-bold text-red-500">COUP</h1>
        <span class="text-gray-400">|</span>
        <h2 class="text-2xl text-gray-300">Admin Panel</h2>
      </div>
      <div class="flex gap-3">
        <a href="/leaderboards.html" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded transition-colors">
          Leaderboards
        </a>
        <a id="profileLink" href="/profile.html" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded transition-colors">
          Profile
        </a>
        <a id="settingsBtn" href="/settings.html" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded transition-colors">
          Settings
        </a>
        <a href="/rules.html" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded transition-colors">
          Rules
        </a>
        <a href="/" class="bg-blue-700 hover:bg-blue-600 px-4 py-2 rounded transition-colors">
          Game Lobby
        </a>
        <button id="logoutBtn" class="bg-red-700 hover:bg-red-600 px-4 py-2 rounded">
          Logout
        </button>
      </div>
    </div>

    <!-- Access Denied -->
    <div id="accessDenied" class="hidden stat-card rounded-lg p-8 text-center">
      <div class="text-4xl mb-3">üîí</div>
      <div class="text-lg font-bold text-gray-300 mb-2">Access Denied</div>
      <div class="text-sm text-gray-400 mb-4">You must be a admin to access this page.</div>
      <a href="/" class="bg-red-700 hover:bg-red-600 px-6 py-2 rounded transition-colors">Go to Lobby</a>
    </div>

    <!-- Content -->
    <div id="content" class="hidden space-y-6">

      <!-- Online Users & Chat -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Online Users -->
        <div class="stat-card rounded-lg p-6">
          <h2 class="text-xl font-bold mb-3 flex items-center gap-2">
            <span>üë•</span>
            <span>Online Users</span>
            <span class="text-sm font-normal text-gray-400">(<span id="onlineCount">0</span>)</span>
          </h2>
          <div id="onlineUsersList" class="space-y-2 overflow-y-auto" style="height: 400px;">
            <!-- Populated by JS -->
          </div>
        </div>

        <!-- Lobby Chat -->
        <div class="stat-card rounded-lg p-6 flex flex-col" style="height: 500px;">
          <h2 class="text-xl font-bold mb-3">üí¨ Lobby Chat</h2>
          
          <!-- Chat Messages -->
          <div id="chatMessages" class="flex-1 overflow-y-auto space-y-2 mb-3 pr-2">
            <!-- Messages will be populated here -->
          </div>
          
          <!-- Chat Input -->
          <form onsubmit="sendChatMessage(event)" class="flex gap-2">
            <input 
              type="text" 
              id="chatInput"
              placeholder="Type a message..."
              class="flex-1 p-2 bg-gray-700 rounded border border-gray-600 text-white text-sm"
              maxlength="200"
              autocomplete="off"
            />
            <button 
              type="submit"
              class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded font-bold text-sm"
            >
              Send
            </button>
          </form>
        </div>
      </div>

      <!-- Users (All or Online) -->
      <div class="stat-card rounded-lg p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-bold">Users</h2>
          <label class="flex items-center gap-2 cursor-pointer">
            <span class="text-sm text-gray-400">Show only online</span>
            <div class="relative">
              <input type="checkbox" id="showOnlyOnline" class="sr-only" onchange="renderUsers()">
              <div class="toggle-bg w-11 h-6 bg-gray-600 rounded-full shadow-inner"></div>
              <div class="toggle-dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div>
            </div>
          </label>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="text-gray-400 border-b border-gray-700">
              <tr>
                <th class="text-left py-2">Username</th>
                <th class="text-left py-2">Role</th>
                <th class="text-left py-2">IP Address</th>
                <th class="text-left py-2">Status</th>
                <th class="text-left py-2">Joined</th>
                <th class="text-right py-2">Actions</th>
              </tr>
            </thead>
            <tbody id="userList" class="divide-y divide-gray-700">
              <!-- Populated by JS -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Admin Log -->
      <div class="stat-card rounded-lg p-6">
        <h2 class="text-2xl font-bold mb-4">Admin Log</h2>
        <div class="space-y-2 max-h-96 overflow-y-auto" id="modLog">
          <!-- Populated by JS -->
        </div>
      </div>

      <!-- Banned IPs -->
      <div class="stat-card rounded-lg p-6">
        <h2 class="text-2xl font-bold mb-4">üö´ Banned IP Addresses</h2>
        <div class="space-y-2 max-h-96 overflow-y-auto" id="bannedIPList">
          <!-- Populated by JS -->
        </div>
      </div>

    </div>

    <!-- Action Modal -->
    <div id="actionModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
      <div class="stat-card rounded-lg p-6 max-w-md w-full mx-4">
        <h3 id="modalTitle" class="text-xl font-bold mb-4"></h3>
        <p id="modalDesc" class="text-gray-400 text-sm mb-4"></p>
        
        <div id="reasonField" class="mb-4">
          <label class="block text-sm text-gray-400 mb-2">Reason (optional)</label>
          <textarea 
            id="reasonInput" 
            rows="3"
            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-red-500"
            placeholder="Enter reason for this action..."></textarea>
        </div>
        
        <div id="passwordField" class="hidden mb-4">
          <label class="block text-sm text-gray-400 mb-2">New Password</label>
          <input 
            type="password"
            id="passwordInput" 
            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-teal-500"
            placeholder="Enter new password (6+ characters)">
          <p class="text-xs text-gray-500 mt-1">Password will be changed immediately. User will need to use this new password to log in.</p>
        </div>
        
        <div id="banIPOption" class="hidden mb-4">
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" id="alsoBanIPCheckbox" class="w-4 h-4">
            <span class="text-sm text-gray-300">Also ban their IP address <span id="ipToBan" class="text-yellow-400"></span></span>
          </label>
        </div>
        
        <div class="flex gap-3">
          <button id="confirmBtn" class="flex-1 bg-red-700 hover:bg-red-600 px-4 py-2 rounded transition-colors font-bold">
            Confirm
          </button>
          <button onclick="closeModal()" class="flex-1 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded transition-colors">
            Cancel
          </button>
        </div>
        
        <div id="modalError" class="hidden mt-3 text-red-400 text-sm"></div>
      </div>
    </div>

  </div>

  <script>
    const API_BASE = '';
    const authToken = localStorage.getItem('coupAuthToken');
    const currentUser = authToken ? JSON.parse(localStorage.getItem('currentUser') || '{}') : null;
    
    let currentRole = 'user';
    let users = [];
    let currentAction = null;
    let onlineUsersWithIPs = [];

    async function checkAccess() {
      if (!authToken) {
        document.getElementById('accessDenied').classList.remove('hidden');
        return false;
      }

      try {
        const res = await fetch(`${API_BASE}/api/verify`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token: authToken })
        });
        
        const data = await res.json();
        
        if (!data.success || !data.role || (data.role !== 'moderator' && data.role !== 'admin')) {
          document.getElementById('accessDenied').classList.remove('hidden');
          return false;
        }
        
        currentRole = data.role;
        return true;
      } catch (e) {
        console.error(e);
        document.getElementById('accessDenied').classList.remove('hidden');
        return false;
      }
    }

    async function loadUsers() {
      try {
        // Fetch registered users
        const res = await fetch(`${API_BASE}/api/moderation/users`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (!res.ok) throw new Error('Failed to load');
        
        const data = await res.json();
        
        // Fetch online users
        const onlineRes = await fetch(`${API_BASE}/api/moderation/online-users`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        const onlineData = await onlineRes.json();
        onlineUsersWithIPs = onlineData.users;
        
        // Merge online data with registered users
        users = data.users.map(user => {
          const onlineUser = onlineUsersWithIPs.find(ou => ou.userId === user.id);
          return {
            ...user,
            ip: onlineUser?.ip || null,
            isOnline: !!onlineUser,
            inGame: onlineUser?.inGame || false,
            isGuest: false
          };
        });
        
        // Add online guests who aren't registered users
        const guests = onlineUsersWithIPs
          .filter(ou => !ou.isAuthenticated || !ou.userId)
          .map(guest => ({
            id: null,
            username: guest.username,
            role: 'user',
            ip: guest.ip,
            isOnline: true,
            inGame: guest.inGame,
            isGuest: true,
            created_at: null,
            banStatus: { banned: false, timedOut: false }
          }));
        
        // Add guests to the users list
        users = [...users, ...guests];
        
        renderUsers();
      } catch (e) {
        console.error('Failed to load users:', e);
      }
    }

    function renderUsers() {
      const container = document.getElementById('userList');
      const showOnlyOnline = document.getElementById('showOnlyOnline').checked;
      
      // Filter users based on toggle
      let filteredUsers = showOnlyOnline ? users.filter(u => u.isOnline) : users;
      
      if (filteredUsers.length === 0) {
        container.innerHTML = '<tr><td colspan="6" class="py-4 text-center text-gray-400">No users found</td></tr>';
        return;
      }
      
      container.innerHTML = filteredUsers.map(user => {
        // Username with guest indicator
        const usernameDisplay = user.isGuest 
          ? `${user.username} <span class="text-xs text-gray-500">(guest)</span>`
          : user.username;
        
        // Status: Show connection state if online, otherwise account state
        let statusBadge = '';
        if (user.isOnline) {
          if (user.inGame) {
            statusBadge = '<span class="text-blue-400">üéÆ In Game</span>';
          } else {
            statusBadge = '<span class="text-green-400">üí§ In Lobby</span>';
          }
        } else if (user.banStatus.banned) {
          statusBadge = '<span class="text-red-400 font-bold">BANNED</span>';
        } else if (user.banStatus.timedOut) {
          const expires = new Date(user.banStatus.expiresAt).toLocaleString();
          statusBadge = `<span class="text-yellow-400 font-bold">TIMED OUT</span><div class="text-xs text-gray-400">Until ${expires}</div>`;
        } else {
          statusBadge = '<span class="text-gray-400">Offline</span>';
        }
        
        let roleBadge = user.role === 'admin' 
          ? '<span class="bg-red-700 px-2 py-1 rounded text-xs font-bold">SUPER ADMIN</span>'
          : user.role === 'moderator'
          ? '<span class="bg-blue-700 px-2 py-1 rounded text-xs font-bold">ADMIN</span>'
          : '<span class="text-gray-400">User</span>';
        
        // IP Address
        const ipDisplay = user.ip 
          ? `<span class="font-mono text-sm text-gray-300">${user.ip}</span>`
          : '<span class="text-gray-500 text-xs">‚Äî</span>';
        
        // Joined date
        const joinedDisplay = user.created_at 
          ? new Date(user.created_at).toLocaleDateString()
          : '<span class="text-gray-500 text-xs">‚Äî</span>';
        
        const isSelf = currentUser && user.username === currentUser.username;
        const canModerate = user.role === 'user' || (currentRole === 'admin' && user.role === 'moderator');
        
        let actions = '';
        if (!isSelf && canModerate) {
          // Escape username for use in onclick handlers (replace single quotes)
          const escapedUsername = user.username.replace(/'/g, "\\'");
          
          // For guests, only show Ban IP button
          if (user.isGuest) {
            if (user.ip && user.ip !== 'unknown') {
              actions = `<button onclick="banIP('${user.ip}', '${escapedUsername}')" class="bg-orange-700 hover:bg-orange-600 px-3 py-1 rounded text-xs transition-colors">Ban IP</button>`;
            }
          } else {
            // For registered users, show full moderation options
            if (user.banStatus.banned || user.banStatus.timedOut) {
              actions = `<button onclick="unbanUser(${user.id}, '${escapedUsername}')" class="bg-green-700 hover:bg-green-600 px-3 py-1 rounded text-xs transition-colors">Unban</button>`;
            } else {
              actions = `
                <button onclick="timeoutUser(${user.id}, '${escapedUsername}')" class="bg-yellow-700 hover:bg-yellow-600 px-3 py-1 rounded text-xs transition-colors mr-2">Timeout</button>
                <button onclick="banUser(${user.id}, '${escapedUsername}')" class="bg-red-700 hover:bg-red-600 px-3 py-1 rounded text-xs transition-colors">Ban</button>
              `;
            }
            
            // Add IP ban button if user is online
            if (user.ip && user.ip !== 'unknown') {
              actions += ` <button onclick="banIP('${user.ip}', '${escapedUsername}')" class="bg-orange-700 hover:bg-orange-600 px-3 py-1 rounded text-xs transition-colors ml-2">Ban IP</button>`;
            }
            
            // Add Reset Password button for registered users
            actions += ` <button onclick="resetPassword(${user.id}, '${escapedUsername}')" class="bg-teal-700 hover:bg-teal-600 px-3 py-1 rounded text-xs transition-colors ml-2">Reset Password</button>`;
            
            if (currentRole === 'admin') {
              if (user.role === 'user') {
                actions += ` <button onclick="promoteUser(${user.id}, '${escapedUsername}')" class="bg-purple-700 hover:bg-purple-600 px-3 py-1 rounded text-xs transition-colors ml-2">Promote</button>`;
              } else if (user.role === 'moderator') {
                actions += ` <button onclick="demoteUser(${user.id}, '${escapedUsername}')" class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-xs transition-colors ml-2">Demote</button>`;
              }
            }
          }
        }
        
        return `
          <tr class="hover:bg-gray-700/30 transition-colors">
            <td class="py-3">${usernameDisplay}</td>
            <td class="py-3">${roleBadge}</td>
            <td class="py-3">${ipDisplay}</td>
            <td class="py-3">${statusBadge}</td>
            <td class="py-3 text-gray-400">${joinedDisplay}</td>
            <td class="py-3 text-right">${actions}</td>
          </tr>
        `;
      }).join('');
    }

    async function loadModLog() {
      try {
        const res = await fetch(`${API_BASE}/api/moderation/log?limit=50`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (!res.ok) throw new Error('Failed to load');
        
        const data = await res.json();
        renderModLog(data.actions);
      } catch (e) {
        console.error('Failed to load mod log:', e);
      }
    }

    function renderModLog(actions) {
      const container = document.getElementById('modLog');
      
      if (!actions || actions.length === 0) {
        container.innerHTML = '<div class="text-gray-400 text-center py-4">No moderation actions yet</div>';
        return;
      }
      
      container.innerHTML = actions.map(action => {
        const date = new Date(action.created_at).toLocaleString();
        let actionColor = 'text-gray-400';
        let actionText = action.action_type;
        
        if (action.action_type === 'ban') {
          actionColor = 'text-red-400 font-bold';
          actionText = 'BANNED';
        } else if (action.action_type === 'timeout') {
          actionColor = 'text-yellow-400 font-bold';
          actionText = 'TIMED OUT (24h)';
        } else if (action.action_type === 'unban') {
          actionColor = 'text-green-400';
          actionText = 'UNBANNED';
        } else if (action.action_type === 'promote') {
          actionColor = 'text-purple-400 font-bold';
          actionText = 'PROMOTED TO ADMIN';
        } else if (action.action_type === 'demote') {
          actionColor = 'text-blue-400';
          actionText = 'DEMOTED TO USER';
        }
        
        return `
          <div class="bg-gray-700/30 rounded p-3 text-sm">
            <div class="flex items-start justify-between">
              <div>
                <span class="${actionColor}">${actionText}</span>
                <span class="text-gray-400"> - </span>
                <span class="text-white">${action.target_username || 'Unknown User'}</span>
              </div>
              <div class="text-xs text-gray-500">${date}</div>
            </div>
            <div class="text-xs text-gray-400 mt-1">
              By: ${action.moderator_username || 'Unknown Admin'}
              ${action.reason ? ` | Reason: ${action.reason}` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    function timeoutUser(userId, username) {
      // Find user's IP if they're online
      const onlineUser = onlineUsersWithIPs.find(u => u.username === username);
      const userIP = onlineUser?.ip;
      
      currentAction = { type: 'timeout', userId, username, ip: userIP };
      document.getElementById('modalTitle').textContent = 'Timeout User';
      document.getElementById('modalDesc').textContent = `Timeout ${username} for 24 hours? They will not be able to access the site until the timeout expires.`;
      
      // Show/hide IP ban option
      if (userIP && userIP !== 'unknown') {
        document.getElementById('banIPOption').classList.remove('hidden');
        document.getElementById('ipToBan').textContent = `(${userIP})`;
        document.getElementById('alsoBanIPCheckbox').checked = false;
      } else {
        document.getElementById('banIPOption').classList.add('hidden');
      }
      
      document.getElementById('reasonField').classList.remove('hidden');
      document.getElementById('passwordField').classList.add('hidden');
      document.getElementById('actionModal').classList.remove('hidden');
    }

    function banUser(userId, username) {
      // Find user's IP if they're online
      const onlineUser = onlineUsersWithIPs.find(u => u.username === username);
      const userIP = onlineUser?.ip;
      
      currentAction = { type: 'ban', userId, username, ip: userIP };
      document.getElementById('modalTitle').textContent = 'Ban User';
      document.getElementById('modalDesc').textContent = `Permanently ban ${username}? This action will prevent them from accessing the site indefinitely.`;
      
      // Show/hide IP ban option
      if (userIP && userIP !== 'unknown') {
        document.getElementById('banIPOption').classList.remove('hidden');
        document.getElementById('ipToBan').textContent = `(${userIP})`;
        document.getElementById('alsoBanIPCheckbox').checked = true; // Default to checked for bans
      } else {
        document.getElementById('banIPOption').classList.add('hidden');
      }
      
      document.getElementById('reasonField').classList.remove('hidden');
      document.getElementById('passwordField').classList.add('hidden');
      document.getElementById('actionModal').classList.remove('hidden');
    }

    function unbanUser(userId, username) {
      currentAction = { type: 'unban', userId, username };
      document.getElementById('modalTitle').textContent = 'Lift Ban/Timeout';
      document.getElementById('modalDesc').textContent = `Remove ban or timeout from ${username}? They will regain full access to the site.`;
      document.getElementById('banIPOption').classList.add('hidden');
      document.getElementById('reasonField').classList.remove('hidden');
      document.getElementById('passwordField').classList.add('hidden');
      document.getElementById('actionModal').classList.remove('hidden');
    }

    function promoteUser(userId, username) {
      currentAction = { type: 'promote', userId, username };
      document.getElementById('modalTitle').textContent = 'Promote to Admin';
      document.getElementById('modalDesc').textContent = `Promote ${username} to admin? They will gain access to this admin panel.`;
      document.getElementById('banIPOption').classList.add('hidden');
      document.getElementById('reasonField').classList.remove('hidden');
      document.getElementById('passwordField').classList.add('hidden');
      document.getElementById('actionModal').classList.remove('hidden');
    }

    function demoteUser(userId, username) {
      currentAction = { type: 'demote', userId, username };
      document.getElementById('modalTitle').textContent = 'Demote to User';
      document.getElementById('modalDesc').textContent = `Demote ${username} to regular user? They will lose admin access.`;
      document.getElementById('banIPOption').classList.add('hidden');
      document.getElementById('reasonField').classList.remove('hidden');
      document.getElementById('passwordField').classList.add('hidden');
      document.getElementById('actionModal').classList.remove('hidden');
    }

    function resetPassword(userId, username) {
      currentAction = { type: 'resetPassword', userId, username };
      document.getElementById('modalTitle').textContent = 'Reset Password';
      document.getElementById('modalDesc').textContent = `Reset password for ${username}? They will need to use the new password to log in.`;
      document.getElementById('banIPOption').classList.add('hidden');
      document.getElementById('reasonField').classList.add('hidden');
      document.getElementById('passwordField').classList.remove('hidden');
      document.getElementById('passwordInput').value = '';
      document.getElementById('actionModal').classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('actionModal').classList.add('hidden');
      document.getElementById('reasonInput').value = '';
      document.getElementById('passwordInput').value = '';
      document.getElementById('modalError').classList.add('hidden');
      document.getElementById('banIPOption').classList.add('hidden');
      currentAction = null;
    }

    document.getElementById('confirmBtn').addEventListener('click', async () => {
      if (!currentAction) return;
      
      const reason = document.getElementById('reasonInput').value;
      const errorEl = document.getElementById('modalError');
      errorEl.classList.add('hidden');
      
      try {
        // Handle IP ban separately
        if (currentAction.type === 'banIP') {
          const res = await fetch(`${API_BASE}/api/moderation/ban-ip`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
              ip: currentAction.ip,
              reason: reason || `Banned from ${currentAction.username}'s connection`
            })
          });
          
          const data = await res.json();
          
          if (!res.ok || !data.success) {
            errorEl.textContent = data.error || 'Failed to ban IP';
            errorEl.classList.remove('hidden');
            return;
          }
          
          closeModal();
          loadUsers();
          loadBannedIPs();
          return;
        }
        
        // Handle IP unban separately
        if (currentAction.type === 'unbanIP') {
          const res = await fetch(`${API_BASE}/api/moderation/unban-ip`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
              ip: currentAction.ip
            })
          });
          
          const data = await res.json();
          
          if (!res.ok || !data.success) {
            errorEl.textContent = data.error || 'Failed to unban IP';
            errorEl.classList.remove('hidden');
            return;
          }
          
          closeModal();
          loadUsers();
          loadBannedIPs();
          return;
        }
        
        // Handle password reset separately
        if (currentAction.type === 'resetPassword') {
          const newPassword = document.getElementById('passwordInput').value.trim();
          
          if (!newPassword) {
            errorEl.textContent = 'Password is required';
            errorEl.classList.remove('hidden');
            return;
          }
          
          if (newPassword.length < 6) {
            errorEl.textContent = 'Password must be at least 6 characters';
            errorEl.classList.remove('hidden');
            return;
          }
          
          const res = await fetch(`${API_BASE}/api/moderation/reset-password`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
              userId: currentAction.userId,
              newPassword
            })
          });
          
          const data = await res.json();
          
          if (!res.ok || !data.success) {
            errorEl.textContent = data.error || 'Failed to reset password';
            errorEl.classList.remove('hidden');
            return;
          }
          
          closeModal();
          loadUsers();
          loadModLog();
          return;
        }
        
        // Handle user-based actions
        const endpoint = currentAction.type === 'promote' ? '/api/moderation/promote'
          : currentAction.type === 'demote' ? '/api/moderation/demote'
          : `/api/moderation/${currentAction.type}`;
        
        const res = await fetch(`${API_BASE}${endpoint}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({
            userId: currentAction.userId,
            reason
          })
        });
        
        const data = await res.json();
        
        if (!res.ok || !data.success) {
          errorEl.textContent = data.error || 'Failed to perform action';
          errorEl.classList.remove('hidden');
          return;
        }
        
        // Check if we should also ban the IP
        const alsoBanIP = document.getElementById('alsoBanIPCheckbox').checked;
        if (alsoBanIP && currentAction.ip && currentAction.ip !== 'unknown') {
          await fetch(`${API_BASE}/api/moderation/ban-ip`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
              ip: currentAction.ip,
              reason: reason || `Banned with user ${currentAction.username}`
            })
          });
          loadBannedIPs();
        }
        
        closeModal();
        loadUsers();
        loadModLog();
      } catch (e) {
        console.error(e);
        errorEl.textContent = 'Network error. Please try again.';
        errorEl.classList.remove('hidden');
      }
    });

    async function init() {
      const hasAccess = await checkAccess();
      if (hasAccess) {
        // Update profile link
        if (currentUser && currentUser.username) {
          document.getElementById('profileLink').href = `/profile.html?user=${currentUser.username}`;
        }
        
        // Add logout handler
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('coupAuthToken');
            window.location.href = '/login.html';
          });
        }
        
        document.getElementById('content').classList.remove('hidden');
        loadUsers();
        loadModLog();
        loadBannedIPs();
        initSocket();
        
        // Refresh users and banned IPs every 10 seconds
        setInterval(() => {
          loadUsers();
          loadBannedIPs();
        }, 10000);
      }
    }

    let onlineUsers = [];
    let socket = null;

    function initSocket() {
      // Load socket.io
      const socketScript = document.createElement('script');
      socketScript.src = '/socket.io/socket.io.js';
      socketScript.onload = () => {
        socket = io({
          auth: { token: authToken }
        });

        socket.on('connect', () => {
          const guestUsername = localStorage.getItem('coupGuestUsername');
          socket.emit('joinLobby', { username: guestUsername });
        });

        socket.on('onlineUsersUpdate', (data) => {
          onlineUsers = data.users;
          updateOnlineUsers();
        });

        socket.on('lobbyChatMessage', (data) => {
          addChatMessage(data);
        });
      };
      document.head.appendChild(socketScript);
    }

    function updateOnlineUsers() {
      const container = document.getElementById('onlineUsersList');
      document.getElementById('onlineCount').textContent = onlineUsers.length;

      const sortedUsers = [...onlineUsers].sort((a, b) => 
        a.username.toLowerCase().localeCompare(b.username.toLowerCase())
      );

      container.innerHTML = sortedUsers.map(user => {
        const isAuth = user.isAuthenticated;
        const isAdmin = user.role === 'admin' || user.role === 'moderator';
        const statusIcon = user.inGame ? 'üéÆ' : 'üí§';
        const statusText = user.inGame ? 'In Game' : 'In Lobby';
        
        return `
          <div class="bg-gray-700 rounded p-2 flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="text-lg">${statusIcon}</span>
              <div>
                ${isAuth
                  ? `<a href="/profile.html?user=${encodeURIComponent(user.username)}" class="font-semibold text-sm text-blue-300 hover:text-blue-100 hover:underline">${user.username}</a>`
                  : `<div class="font-semibold text-sm">${user.username}</div>`
                }
                <div class="text-xs text-gray-400">${statusText}</div>
              </div>
            </div>
            ${isAdmin ? '<span class="text-xs text-red-500">üõ°Ô∏è</span>' : isAuth ? '<span class="text-xs text-green-500">‚≠ê</span>' : '<span class="text-xs text-gray-500">üë§</span>'}
          </div>
        `;
      }).join('');
    }

    function addChatMessage(data) {
      const container = document.getElementById('chatMessages');
      const messageEl = document.createElement('div');
      messageEl.className = 'fade-in text-sm';
      
      const isAuth = data.isAuthenticated;
      const isAdmin = data.role === 'admin' || data.role === 'moderator';
      const badge = isAdmin ? '<span class="text-red-500 text-xs">üõ°Ô∏è</span>' : isAuth ? '<span class="text-green-500 text-xs">‚≠ê</span>' : '';
      const nameHtml = isAuth
        ? `<a href="/profile.html?user=${encodeURIComponent(data.username)}" class="font-bold text-blue-400 hover:text-blue-200 hover:underline">${data.username}</a>`
        : `<span class="font-bold text-blue-400">${data.username}</span>`;
      
      // Apply profanity filter
      const filteredMessage = filterProfanity(data.message);
      
      messageEl.innerHTML = `
        <div class="bg-gray-700 rounded p-2">
          ${nameHtml}
          ${badge}
          <span class="text-gray-500 text-xs ml-2">${new Date(data.timestamp).toLocaleTimeString()}</span>
          <div class="text-gray-200 mt-1">${escapeHtml(filteredMessage)}</div>
        </div>
      `;
      
      container.appendChild(messageEl);
      container.scrollTop = container.scrollHeight;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function sendChatMessage(event) {
      event.preventDefault();
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message || !socket) return;
      
      socket.emit('lobbyChatMessage', { message });
      input.value = '';
      input.focus();
    }

    async function loadBannedIPs() {
      try {
        const res = await fetch(`${API_BASE}/api/moderation/banned-ips`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (!res.ok) throw new Error('Failed to load');
        
        const data = await res.json();
        renderBannedIPs(data.ips);
      } catch (e) {
        console.error('Failed to load banned IPs:', e);
      }
    }

    function renderBannedIPs(ips) {
      const container = document.getElementById('bannedIPList');
      
      if (!ips || ips.length === 0) {
        container.innerHTML = '<div class="text-gray-400 text-center py-4">No banned IP addresses</div>';
        return;
      }
      
      container.innerHTML = ips.map(ip => {
        const date = new Date(ip.banned_at).toLocaleDateString();
        return `
          <div class="bg-gray-700/30 rounded p-3 text-sm flex items-center justify-between">
            <div>
              <div class="font-mono text-white">${ip.ip_address}</div>
              <div class="text-xs text-gray-400 mt-1">
                Banned on ${date} by ${ip.banned_by_username || 'Unknown'}
                ${ip.reason ? ` | ${ip.reason}` : ''}
              </div>
            </div>
            <button onclick="unbanIP('${ip.ip_address}')" class="bg-green-700 hover:bg-green-600 px-3 py-1 rounded text-xs transition-colors">
              Unban
            </button>
          </div>
        `;
      }).join('');
    }

    function banIP(ip, username) {
      currentAction = { type: 'banIP', ip, username };
      document.getElementById('modalTitle').textContent = 'Ban IP Address';
      document.getElementById('modalDesc').textContent = `Ban IP address ${ip} (${username})? This will immediately disconnect them and prevent reconnection.`;
      document.getElementById('banIPOption').classList.add('hidden');
      document.getElementById('reasonField').classList.remove('hidden');
      document.getElementById('passwordField').classList.add('hidden');
      document.getElementById('actionModal').classList.remove('hidden');
    }

    function unbanIP(ip) {
      currentAction = { type: 'unbanIP', ip };
      document.getElementById('modalTitle').textContent = 'Unban IP Address';
      document.getElementById('modalDesc').textContent = `Unban IP address ${ip}? This will allow connections from this IP address again.`;
      document.getElementById('banIPOption').classList.add('hidden');
      document.getElementById('reasonField').classList.remove('hidden');
      document.getElementById('passwordField').classList.add('hidden');
      document.getElementById('actionModal').classList.remove('hidden');
    }

    init();
  </script>
</body>
</html>
