<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leaderboards - Coup</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
      background: linear-gradient(to bottom right, #7f1d1d, #1f2937, #000000);
      min-height: 100vh;
    }
    
    .leaderboard-card {
      background: rgba(31, 41, 55, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(75, 85, 99, 0.3);
      transition: all 0.3s ease;
    }
    
    .leaderboard-row {
      transition: all 0.2s ease;
    }
    
    .leaderboard-row:hover {
      background: rgba(55, 65, 81, 0.6);
      transform: translateX(5px);
    }
    
    .rank-1 { 
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: #000;
    }
    
    .rank-2 { 
      background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
      color: #000;
    }
    
    .rank-3 { 
      background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
      color: #000;
    }
    
    .tab-button {
      transition: all 0.3s ease;
    }
    
    .tab-button.active {
      background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(220, 38, 38, 0.3);
    }
    
    .skeleton {
      background: linear-gradient(90deg, #374151 25%, #4b5563 50%, #374151 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }
    
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    .highlight-me {
      background: rgba(59, 130, 246, 0.2);
      border-left: 4px solid #3b82f6;
    }
  </style>
</head>
<body class="text-white">
  <div class="max-w-7xl mx-auto p-4 md:p-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
      <h1 class="text-4xl font-bold text-red-500">üèÜ COUP LEADERBOARDS</h1>
      <div class="flex gap-3">
        <a href="/" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded transition-colors">
          Back to Game
        </a>
      </div>
    </div>

    <!-- User Info (if logged in) -->
    <div id="userInfo" class="hidden leaderboard-card rounded-lg p-6 mb-6">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-sm text-gray-400">Your Stats</div>
          <div class="text-2xl font-bold text-blue-400" id="currentUsername"></div>
        </div>
        <div class="flex gap-4 text-center">
          <div>
            <div class="text-gray-400 text-xs">Elo Rating</div>
            <div class="text-2xl font-bold text-yellow-500" id="userElo">-</div>
          </div>
          <div>
            <div class="text-gray-400 text-xs">Global Rank</div>
            <div class="text-2xl font-bold text-green-500" id="userRank">-</div>
          </div>
          <div>
            <div class="text-gray-400 text-xs">Win Rate</div>
            <div class="text-2xl font-bold text-purple-500" id="userWinRate">-</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Leaderboard Tabs -->
    <div class="flex flex-wrap gap-2 mb-6">
      <button onclick="switchLeaderboard('elo')" class="tab-button active bg-gray-700 hover:bg-gray-600 px-6 py-3 rounded font-bold" data-tab="elo">
        ‚≠ê Elo Rating
      </button>
      <button onclick="switchLeaderboard('winrate')" class="tab-button bg-gray-700 hover:bg-gray-600 px-6 py-3 rounded font-bold" data-tab="winrate">
        üìà Win Rate
      </button>
      <button onclick="switchLeaderboard('wins')" class="tab-button bg-gray-700 hover:bg-gray-600 px-6 py-3 rounded font-bold" data-tab="wins">
        üéØ Total Wins
      </button>
      <button onclick="switchLeaderboard('kd')" class="tab-button bg-gray-700 hover:bg-gray-600 px-6 py-3 rounded font-bold" data-tab="kd">
        ‚öîÔ∏è K/D Ratio
      </button>
      <button onclick="switchLeaderboard('bluffer')" class="tab-button bg-gray-700 hover:bg-gray-600 px-6 py-3 rounded font-bold" data-tab="bluffer">
        üé≠ Master Bluffer
      </button>
      <button onclick="switchLeaderboard('tax')" class="tab-button bg-gray-700 hover:bg-gray-600 px-6 py-3 rounded font-bold" data-tab="tax">
        üíé Tax Collector
      </button>
      <button onclick="switchLeaderboard('assassin')" class="tab-button bg-gray-700 hover:bg-gray-600 px-6 py-3 rounded font-bold" data-tab="assassin">
        üó°Ô∏è Assassin
      </button>
      <button onclick="switchLeaderboard('finisher')" class="tab-button bg-gray-700 hover:bg-gray-600 px-6 py-3 rounded font-bold" data-tab="finisher">
        üéØ Finisher
      </button>
      <button onclick="switchLeaderboard('economist')" class="tab-button bg-gray-700 hover:bg-gray-600 px-6 py-3 rounded font-bold" data-tab="economist">
        üí∞ Economist
      </button>
    </div>

    <!-- Loading State -->
    <div id="loading" class="text-center py-20">
      <div class="text-6xl mb-4">‚è≥</div>
      <div class="text-2xl">Loading leaderboards...</div>
    </div>

    <!-- Error State -->
    <div id="error" class="hidden bg-red-900 border border-red-600 rounded-lg p-8 text-center">
      <div class="text-6xl mb-4">‚ùå</div>
      <div class="text-2xl mb-4">Error Loading Leaderboards</div>
      <div id="errorMessage" class="text-gray-300 mb-4"></div>
      <button onclick="loadLeaderboard(currentLeaderboard)" class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded">
        Retry
      </button>
    </div>

    <!-- Leaderboard Content -->
    <div id="leaderboardContent" class="hidden">
      <!-- Leaderboard Header -->
      <div class="leaderboard-card rounded-lg p-6 mb-4">
        <div class="flex justify-between items-center">
          <div>
            <h2 id="leaderboardTitle" class="text-3xl font-bold mb-2"></h2>
            <p id="leaderboardDescription" class="text-gray-400"></p>
          </div>
          <div class="text-right text-sm text-gray-400">
            <div>Minimum <span class="font-bold text-white">5</span> games played</div>
            <div id="playerCount" class="text-lg font-bold text-yellow-500 mt-1">-</div>
          </div>
        </div>
      </div>

      <!-- Top 3 Podium (for Elo leaderboard) -->
      <div id="podium" class="hidden grid grid-cols-3 gap-4 mb-6">
        <!-- 2nd Place -->
        <div class="leaderboard-card rounded-lg p-6 text-center mt-8">
          <div class="text-6xl mb-3">ü•à</div>
          <div id="podium2" class="podium-player"></div>
        </div>
        
        <!-- 1st Place -->
        <div class="leaderboard-card rounded-lg p-6 text-center ring-4 ring-yellow-500">
          <div class="text-8xl mb-3">ü•á</div>
          <div id="podium1" class="podium-player"></div>
        </div>
        
        <!-- 3rd Place -->
        <div class="leaderboard-card rounded-lg p-6 text-center mt-12">
          <div class="text-5xl mb-3">ü•â</div>
          <div id="podium3" class="podium-player"></div>
        </div>
      </div>

      <!-- Leaderboard Table -->
      <div class="leaderboard-card rounded-lg overflow-hidden">
        <table class="w-full">
          <thead class="bg-gray-900">
            <tr>
              <th class="px-6 py-4 text-left text-sm font-bold text-gray-400">Rank</th>
              <th class="px-6 py-4 text-left text-sm font-bold text-gray-400">Player</th>
              <th class="px-6 py-4 text-right text-sm font-bold text-gray-400" id="statHeader">Stat</th>
              <th class="px-6 py-4 text-right text-sm font-bold text-gray-400">Games</th>
              <th class="px-6 py-4 text-right text-sm font-bold text-gray-400">Wins</th>
              <th class="px-6 py-4 text-right text-sm font-bold text-gray-400">Win Rate</th>
              <th class="px-6 py-4 text-right text-sm font-bold text-gray-400">Elo</th>
            </tr>
          </thead>
          <tbody id="leaderboardRows">
            <!-- Dynamically populated -->
          </tbody>
        </table>
      </div>

      <!-- Pagination (if needed) -->
      <div id="pagination" class="hidden flex justify-center gap-3 mt-6">
        <button onclick="loadMore()" class="bg-gray-700 hover:bg-gray-600 px-6 py-3 rounded font-bold">
          Load More
        </button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    let currentLeaderboard = 'elo';
    let currentUser = null;
    let authToken = localStorage.getItem('coupAuthToken');

    const leaderboardConfig = {
      elo: {
        title: '‚≠ê Elo Rating Leaderboard',
        description: 'The ultimate ranking based on competitive skill rating',
        statLabel: 'Elo Rating',
        showPodium: true
      },
      winrate: {
        title: 'üìà Win Rate Leaderboard',
        description: 'Players with the highest win percentage',
        statLabel: 'Win Rate',
        showPodium: false
      },
      wins: {
        title: 'üéØ Total Wins Leaderboard',
        description: 'Most games won',
        statLabel: 'Wins',
        showPodium: false
      },
      kd: {
        title: '‚öîÔ∏è K/D Ratio Leaderboard',
        description: 'Players eliminated vs influences lost',
        statLabel: 'K/D Ratio',
        showPodium: false
      },
      bluffer: {
        title: 'üé≠ Master Bluffer Leaderboard',
        description: 'Most successful bluffs',
        statLabel: 'Bluffs',
        showPodium: false
      },
      tax: {
        title: 'üíé Tax Collector Leaderboard',
        description: 'Most successful tax collections',
        statLabel: 'Tax Success',
        showPodium: false
      },
      assassin: {
        title: 'üó°Ô∏è Assassin Leaderboard',
        description: 'Most successful assassinations',
        statLabel: 'Assassinations',
        showPodium: false
      },
      finisher: {
        title: 'üéØ Finisher Leaderboard',
        description: 'Most players eliminated',
        statLabel: 'Eliminations',
        showPodium: false
      },
      economist: {
        title: 'üí∞ Economist Leaderboard',
        description: 'Most coins earned',
        statLabel: 'Coins Earned',
        showPodium: false
      }
    };

    async function verifyAuth() {
      if (!authToken) return;

      try {
        const response = await fetch(`${API_BASE}/api/verify`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token: authToken })
        });

        const data = await response.json();

        if (data.success) {
          currentUser = data.user;
          displayUserInfo();
        }
      } catch (error) {
        console.error('Auth verification error:', error);
      }
    }

    function displayUserInfo() {
      if (!currentUser) return;

      const userInfo = document.getElementById('userInfo');
      userInfo.classList.remove('hidden');

      document.getElementById('currentUsername').textContent = currentUser.username;

      if (currentUser.stats) {
        document.getElementById('userElo').textContent = currentUser.stats.elo_rating || 1200;
        
        const winRate = currentUser.stats.games_played > 0 
          ? ((currentUser.stats.games_won / currentUser.stats.games_played) * 100).toFixed(1)
          : 0;
        document.getElementById('userWinRate').textContent = winRate + '%';
      }

      // Load user's rank
      loadUserRank('elo');
    }

    async function loadUserRank(type) {
      if (!authToken || !currentUser) return;

      try {
        const response = await fetch(`${API_BASE}/api/leaderboards/me/${type}`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        const data = await response.json();

        if (data.rank) {
          document.getElementById('userRank').textContent = '#' + data.rank;
        }
      } catch (error) {
        console.error('Error loading user rank:', error);
      }
    }

    async function loadLeaderboard(type) {
      currentLeaderboard = type;
      
      // Update tab styling
      document.querySelectorAll('.tab-button').forEach(btn => {
        if (btn.dataset.tab === type) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });

      // Show loading
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('error').classList.add('hidden');
      document.getElementById('leaderboardContent').classList.add('hidden');

      try {
        const response = await fetch(`${API_BASE}/api/leaderboards/${type}?limit=100&minGames=5`);
        
        if (!response.ok) {
          throw new Error('Failed to load leaderboard');
        }

        const data = await response.json();

        // Hide loading, show content
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('leaderboardContent').classList.remove('hidden');

        // Update header
        const config = leaderboardConfig[type];
        document.getElementById('leaderboardTitle').textContent = config.title;
        document.getElementById('leaderboardDescription').textContent = config.description;
        document.getElementById('statHeader').textContent = config.statLabel;
        document.getElementById('playerCount').textContent = `${data.leaderboard.length} players`;

        // Show/hide podium
        const podium = document.getElementById('podium');
        if (config.showPodium && data.leaderboard.length >= 3) {
          podium.classList.remove('hidden');
          renderPodium(data.leaderboard.slice(0, 3));
        } else {
          podium.classList.add('hidden');
        }

        // Render leaderboard
        renderLeaderboard(data.leaderboard, type);

        // Update user's rank for this leaderboard
        if (currentUser) {
          loadUserRank(type);
        }

      } catch (error) {
        console.error('Error loading leaderboard:', error);
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('error').classList.remove('hidden');
        document.getElementById('errorMessage').textContent = error.message;
      }
    }

    function renderPodium(topThree) {
      if (topThree.length >= 1) {
        const player1 = topThree[0];
        document.getElementById('podium1').innerHTML = `
          <a href="/profile.html?user=${player1.username}" class="text-xl font-bold text-yellow-300 hover:text-yellow-200">
            ${player1.username}
          </a>
          <div class="text-3xl font-bold text-yellow-500 mt-2">${formatStat(player1.primaryStat)}</div>
          <div class="text-sm text-gray-400 mt-1">${player1.secondaryStats.gamesWon}W - ${player1.secondaryStats.gamesPlayed - player1.secondaryStats.gamesWon}L</div>
        `;
      }

      if (topThree.length >= 2) {
        const player2 = topThree[1];
        document.getElementById('podium2').innerHTML = `
          <a href="/profile.html?user=${player2.username}" class="text-lg font-bold text-gray-300 hover:text-gray-200">
            ${player2.username}
          </a>
          <div class="text-2xl font-bold text-gray-400 mt-2">${formatStat(player2.primaryStat)}</div>
          <div class="text-sm text-gray-400 mt-1">${player2.secondaryStats.gamesWon}W - ${player2.secondaryStats.gamesPlayed - player2.secondaryStats.gamesWon}L</div>
        `;
      }

      if (topThree.length >= 3) {
        const player3 = topThree[2];
        document.getElementById('podium3').innerHTML = `
          <a href="/profile.html?user=${player3.username}" class="text-lg font-bold text-orange-300 hover:text-orange-200">
            ${player3.username}
          </a>
          <div class="text-2xl font-bold text-orange-500 mt-2">${formatStat(player3.primaryStat)}</div>
          <div class="text-sm text-gray-400 mt-1">${player3.secondaryStats.gamesWon}W - ${player3.secondaryStats.gamesPlayed - player3.secondaryStats.gamesWon}L</div>
        `;
      }
    }

    function renderLeaderboard(leaderboard, type) {
      const tbody = document.getElementById('leaderboardRows');
      tbody.innerHTML = '';

      leaderboard.forEach(player => {
        const isMe = currentUser && currentUser.username === player.username;
        const row = document.createElement('tr');
        row.className = `leaderboard-row border-t border-gray-700 ${isMe ? 'highlight-me' : ''}`;

        const rankBadge = player.rank === 1 ? 'rank-1' :
                         player.rank === 2 ? 'rank-2' :
                         player.rank === 3 ? 'rank-3' : 'bg-gray-700';

        row.innerHTML = `
          <td class="px-6 py-4">
            <div class="${rankBadge} inline-block px-3 py-1 rounded-full font-bold min-w-[3rem] text-center">
              ${player.rank <= 3 ? (player.rank === 1 ? 'ü•á' : player.rank === 2 ? 'ü•à' : 'ü•â') : '#' + player.rank}
            </div>
          </td>
          <td class="px-6 py-4">
            <a href="/profile.html?user=${player.username}" class="font-bold text-lg hover:text-red-400 transition-colors">
              ${player.username}
            </a>
            ${isMe ? '<span class="ml-2 text-xs bg-blue-600 px-2 py-1 rounded">YOU</span>' : ''}
          </td>
          <td class="px-6 py-4 text-right">
            <div class="text-2xl font-bold text-yellow-400">${formatStat(player.primaryStat)}</div>
          </td>
          <td class="px-6 py-4 text-right text-gray-300">${player.secondaryStats.gamesPlayed}</td>
          <td class="px-6 py-4 text-right text-green-400">${player.secondaryStats.gamesWon}</td>
          <td class="px-6 py-4 text-right text-purple-400">${player.secondaryStats.winRate}%</td>
          <td class="px-6 py-4 text-right text-yellow-500">${player.secondaryStats.elo}</td>
        `;

        tbody.appendChild(row);
      });
    }

    function formatStat(value) {
      if (typeof value === 'number') {
        // Check if it has decimals
        if (value % 1 !== 0) {
          return value.toFixed(2);
        }
        return value.toLocaleString();
      }
      return value;
    }

    function switchLeaderboard(type) {
      loadLeaderboard(type);
    }

    // Initialize
    async function init() {
      await verifyAuth();
      await loadLeaderboard('elo');
    }

    init();
    
    // Socket.io connection for online user tracking
    const socketScript = document.createElement('script');
    socketScript.src = '/socket.io/socket.io.js';
    socketScript.onload = () => {
      const authToken = localStorage.getItem('coupAuthToken');
      const socket = io({
        auth: { token: authToken }
      });
      
      socket.on('connect', () => {
        // For guests, get username from localStorage
        const guestUsername = localStorage.getItem('coupGuestUsername');
        // Server will use authenticatedUser.username if token is valid, otherwise uses this
        socket.emit('joinLobby', { username: guestUsername });
      });
    };
    document.head.appendChild(socketScript);
  </script>
</body>
</html>